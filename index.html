<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>engineering tools by Terminal_Dev</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons for aesthetics -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Apply the Inter font globally */
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s, color 0.3s; /* Smooth theme transition */
        }
        /* Style for LaTeX/formula display */
        .formula-text { 
            font-family: 'Times New Roman', serif; 
            font-style: italic; 
            font-weight: bold; 
        }
        /* Custom scrollbar for dark mode */
        .bg-gray-900 ::-webkit-scrollbar { width: 8px; }
        .bg-gray-900 ::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        .bg-gray-900 ::-webkit-scrollbar-track { background-color: #1f2937; }
        /* Custom scrollbar for light mode */
        .bg-gray-50 ::-webkit-scrollbar { width: 8px; }
        .bg-gray-50 ::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 4px; }
        .bg-gray-50 ::-webkit-scrollbar-track { background-color: #f3f4f6; }

        /* Canvas fix for responsiveness */
        #graphing-canvas { 
            width: 100%; 
            height: 400px; 
            /* Prevent horizontal scroll if container is too small */
            max-width: 100%;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen"> <!-- Body classes applied by JS -->

    <div id="app-container" class="min-h-screen">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <script>
        // --- Global State ---
        const state = {
            view: 'home', 
            theme: 'dark', // 'dark' or 'light'
            precision: 4, 
            angleMode: 'radians', 

            // Calculator State
            calcMode: 'scientific', 
            calcInput: '',
            calcResult: '',
            calcError: '',
            // Pre-load with examples for linear and quadratic functions
            functionInputs: [
                { id: Date.now(), input: '2*x + 1', color: '#3b82f6' }, // Example Linear Function
                { id: Date.now() + 1, input: 'x**2 - 4', color: '#ef4444' } // Example Quadratic Function
            ],

            // Simple Machine State
            activeSmTab: 'general',
            smInputs: {
                Fe_gen: '', De_gen: '', Fr_gen: '', Dr_gen: '', Eff_gen: '',
                De_lev: '', Dr_lev: '', Fe_lev: '', Fr_lev: '', Eff_lev: '',
                De_wa: '', Dr_wa: '', Fe_wa: '', Fr_wa: '', Eff_wa: '',
                Ima_pul: '', Fe_pul: '', Fr_pul: '', Eff_pul: '',
                De_ip: '', Dr_ip: '', Fe_ip: '', Fr_ip: '', Eff_ip: '',
                De_wed: '', Dr_wed: '', Fe_wed: '', Fr_wed: '', Eff_wed: '',
                r_scr: '', p_scr: '', Fe_scr: '', Fr_scr: '', Eff_scr: '',
            },
            smResults: {},
            smError: '',
        };
        
        // --- Theme Management ---
        
        /**
         * Returns Tailwind class strings based on the current theme and component type.
         */
        const getThemeClasses = (component) => {
            if (state.theme === 'light') {
                switch (component) {
                    case 'body': return 'bg-gray-50 text-gray-900';
                    case 'card': return 'bg-white text-gray-900 shadow-xl';
                    case 'inner-card': return 'bg-gray-100 border border-gray-300';
                    case 'subtle-text': return 'text-gray-600';
                    case 'input-field': return 'bg-white text-gray-900 border border-gray-300 focus:border-indigo-500 focus:ring-indigo-500';
                    case 'calc-btn-std': return 'bg-gray-200 hover:bg-gray-300 text-gray-900';
                    case 'calc-btn-accent': return 'bg-indigo-600 hover:bg-indigo-700 text-white';
                    case 'calc-btn-clear': return 'bg-red-100 hover:bg-red-200 text-red-700';
                    case 'error-box': return 'p-3 mb-4 rounded-xl text-sm text-red-800 bg-red-100 border border-red-300';
                    case 'tab-active': return 'bg-gray-200 text-indigo-700 border-b-2 border-indigo-700';
                    case 'tab-inactive': return 'text-gray-600 hover:bg-gray-200';
                    default: return '';
                }
            } else { // Dark mode
                switch (component) {
                    case 'body': return 'bg-gray-900 text-white';
                    case 'card': return 'bg-gray-800 text-white shadow-2xl';
                    case 'inner-card': return 'bg-gray-700 border border-gray-700';
                    case 'subtle-text': return 'text-gray-400';
                    case 'input-field': return 'bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500';
                    case 'calc-btn-std': return 'bg-gray-800 hover:bg-gray-700';
                    case 'calc-btn-accent': return 'bg-indigo-600 hover:bg-indigo-700/80 text-white';
                    case 'calc-btn-clear': return 'bg-red-600/20 hover:bg-red-600/30 text-red-300';
                    case 'error-box': return 'p-3 mb-4 rounded-xl text-sm text-red-300 bg-red-800/50 border border-red-700';
                    case 'tab-active': return 'bg-gray-700 text-indigo-400 border-b-2 border-indigo-400';
                    case 'tab-inactive': return 'text-gray-400 hover:bg-gray-700';
                    default: return '';
                }
            }
        }

        /**
         * Applies the body theme classes (needed for background and default text).
         */
        const applyTheme = (theme) => {
            const body = document.body;
            const themeClasses = getThemeClasses('body');
            // Remove existing theme classes (if any) and apply the new ones
            body.className = body.className.split(' ').filter(cls => !cls.startsWith('bg-') && !cls.startsWith('text-')).join(' ');
            body.classList.add(...themeClasses.split(' '));
        }

        /**
         * Toggles the theme state and re-renders the application.
         */
        const toggleTheme = () => {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            applyTheme(state.theme);
            renderApp();
        };

        // --- Rest of Global Constants and Logic ---
        
        // Increased to 15 colors for the increased function limit
        const graphColors = [
            '#3b82f6', // Blue (Tailwind 500)
            '#ef4444', // Red (Tailwind 500)
            '#10b981', // Emerald (Tailwind 500)
            '#f59e0b', // Amber (Tailwind 500)
            '#8b5cf6', // Violet (Tailwind 500)
            '#ec4899', // Pink (Tailwind 500)
            '#06b6d4', // Cyan (Tailwind 500)
            '#6d28d9', // Deep Purple (Tailwind 700)
            '#e11d48', // Rose (Tailwind 600)
            '#4ade80', // Light Green (Tailwind 400)
            '#facc15', // Yellow (Tailwind 400)
            '#7c3aed', // Indigo (Tailwind 600)
            '#a855f7', // Fuchsia (Tailwind 500)
            '#ca8a04', // Dark Amber (Tailwind 700)
            '#475569', // Slate (Tailwind 600)
        ];

        const MAX_FUNCTIONS = 15; // Set the new maximum limit
        let nextFunctionId = Date.now() + 2; // Start after the two initial functions
        const getNextFunctionId = () => nextFunctionId++;

        const MachineConfigs = {
            'lever': {
                prefix: 'lev', formula: (i) => i.De / i.Dr,
                imaLabels: { De: 'Effort Arm Length ($L_e$)', Dr: 'Resistance Arm Length ($L_r$)' },
            },
            'wheel-axle': {
                prefix: 'wa', formula: (i) => i.De / i.Dr,
                imaLabels: { De: 'Radius of Wheel ($R_{wheel}$)', Dr: 'Radius of Axle ($R_{axle}$)' },
            },
            'inclined-plane': {
                prefix: 'ip', formula: (i) => i.De / i.Dr,
                imaLabels: { De: 'Incline Length ($L$)', Dr: 'Vertical Height ($h$)' },
            },
            'wedge': {
                prefix: 'wed', formula: (i) => i.De / i.Dr,
                imaLabels: { De: 'Wedge Length ($L$)', Dr: 'Wedge Thickness ($t$)' },
            },
            'pulley': {
                prefix: 'pul', formula: (i) => i.Ima,
                imaLabels: { Ima: 'Number of Supporting Ropes ($N$)' },
            },
            'screw': {
                prefix: 'scr', formula: (i) => (2 * Math.PI * i.r) / i.p,
                imaLabels: { r: 'Effort Radius ($r$)', p: 'Pitch ($p$)' },
            }
        };

        const tabLabels = {
            'general': 'General Solver', 'lever': 'Lever', 'wheel-axle': 'Wheel & Axle', 
            'pulley': 'Pulley', 'inclined-plane': 'Inclined Plane', 'wedge': 'Wedge', 'screw': 'Screw',
        };

        const missingNameMap = { 
            Fe: 'Effort Force ($F_e$)', De: 'Effort Distance ($D_e$)', 
            Fr: 'Resistance Force ($F_r$)', Dr: 'Resistance Distance ($D_r$)', 
            Eff_perc: 'Efficiency ($\eta$)' 
        };
        
        // --- Utility Functions ---

        /**
         * Safely evaluates a math expression, handles angle conversion.
         */
        const createMathFunction = (expression, angleMode) => {
            let funcBody = expression.toLowerCase();
            
            // Fix 2: Ensure ^ is replaced with ** for exponents (retaining this fix)
            funcBody = funcBody.replace(/\^/g, '**');

            // Replace common math functions/constants
            funcBody = funcBody.replace(/sin/g, 'Math.sin');
            funcBody = funcBody.replace(/cos/g, 'Math.cos');
            funcBody = funcBody.replace(/tan/g, 'Math.tan');
            funcBody = funcBody.replace(/log/g, 'Math.log');
            funcBody = funcBody.replace(/exp/g, 'Math.exp');
            funcBody = funcBody.replace(/sqrt/g, 'Math.sqrt');
            funcBody = funcBody.replace(/pi/g, 'Math.PI');
            funcBody = funcBody.replace(/e\b/g, 'Math.E');
            
            // Handle Degrees to Radians conversion for trig functions if angleMode is 'degrees'
            if (angleMode === 'degrees') {
                funcBody = funcBody.replace(/Math\.sin\(([^)]+)\)/g, 'Math.sin( (parseFloat($1) * Math.PI / 180) )');
                funcBody = funcBody.replace(/Math\.cos\(([^)]+)\)/g, 'Math.cos( (parseFloat($1) * Math.PI / 180) )');
                funcBody = funcBody.replace(/Math\.tan\(([^)]+)\)/g, 'Math.tan( (parseFloat($1) * Math.PI / 180) )');
            }

            try {
                // eslint-disable-next-line no-new-func
                return new Function('x', `
                    "use strict";
                    try {
                        const X = parseFloat(x);
                        return ${funcBody};
                    } catch (e) {
                        return NaN;
                    }
                `);
            } catch (e) {
                return () => { throw new Error("Invalid Function Syntax"); };
            }
        };

        /**
         * Formats a number to the specified decimal precision.
         */
        const formatNumber = (num, unit = '', precision) => {
            if (num === null || isNaN(num) || !isFinite(num)) return '--';
            return `${parseFloat(num).toFixed(precision)}${unit}`;
        };

        /**
         * Renders the output card HTML block.
         */
        const renderOutputCard = (title, value, unit, color) => {
            // Adjust card text based on theme for contrast
            const cardTextColor = state.theme === 'light' ? 'text-gray-900' : 'text-white';
            const subtitleColor = state.theme === 'light' ? 'text-gray-700' : 'text-gray-200';

            return `
                <div class="p-4 rounded-xl border-l-4 ${color.border} ${color.bg}">
                    <p class="text-sm font-medium ${subtitleColor}">${title}:</p>
                    <p class="text-2xl font-extrabold ${cardTextColor} mt-1">
                        ${formatNumber(value, unit, state.precision)}
                    </p>
                </div>
            `;
        };
        
        // --- Simple Machine Logic (Only minor class updates here) ---

        /**
         * Handles input change, stores value, and restores focus after re-render (needed for number inputs which don't support cursor).
         */
        const handleSmInputChange = (e, key) => {
            state.smInputs[key] = e.target.value;
            state.smError = '';

            const activeElement = e.target;
            const inputKey = activeElement.getAttribute('data-key');
            const cursorStart = activeElement.selectionStart;
            const cursorEnd = activeElement.selectionEnd;

            renderSimpleMachineView(false); 

            if (inputKey) {
                setTimeout(() => {
                    const newActiveElement = document.querySelector(`[data-key="${inputKey}"]`);
                    if (newActiveElement) {
                        newActiveElement.focus();
                        newActiveElement.selectionStart = cursorStart;
                        newActiveElement.selectionEnd = cursorEnd;
                    }
                }, 0);
            }
        };

        const calculateGeneral = () => {
            // (Calculation logic remains the same)
            state.smResults = {};
            state.smError = '';

            const inputs = {
                Fe: parseFloat(state.smInputs.Fe_gen),
                De: parseFloat(state.smInputs.De_gen),
                Fr: parseFloat(state.smInputs.Fr_gen),
                Dr: parseFloat(state.smInputs.Dr_gen),
                Eff_perc: parseFloat(state.smInputs.Eff_gen)
            };
            
            const inputsRatio = {...inputs, Eff: inputs.Eff_perc / 100};

            const presentCount = Object.values(inputs).filter(val => !isNaN(val)).length;
            let missingVar = null;

            if (presentCount !== 4) {
                state.smError = `Please enter **exactly four** of the five values. You entered ${presentCount}.`;
                renderSimpleMachineView(false);
                return;
            }

            for (const key in inputs) {
                if (isNaN(inputs[key])) {
                    missingVar = key;
                    break;
                }
            }
            
            const i = {...inputsRatio};
            delete i.Eff_perc;
            
            let missingValue = NaN;

            try {
                switch (missingVar) {
                    case 'Fe': missingValue = (i.Fr * i.Dr) / (i.De * i.Eff); break;
                    case 'De': missingValue = (i.Fr * i.Dr) / (i.Fe * i.Eff); break;
                    case 'Fr': missingValue = (i.Fe * i.De * i.Eff) / i.Dr; break;
                    case 'Dr': missingValue = (i.Fe * i.De * i.Eff) / i.Fr; break;
                    case 'Eff_perc':
                        const IMA_calc = i.De / i.Dr;
                        const AMA_calc = i.Fr / i.Fe;
                        missingValue = (AMA_calc / IMA_calc) * 100;
                        break;
                    default: throw new Error("Missing variable not identified.");
                }

                if (!isFinite(missingValue) || missingValue < 0) {
                    state.smError = `Error: Result is non-finite or negative. Check for zero divisions or invalid inputs.`;
                    renderSimpleMachineView(false);
                    return;
                }

                let finalIMA, finalAMA, finalEff;

                if (missingVar === 'Eff_perc') {
                    finalEff = missingValue / 100;
                } else {
                    i[missingVar] = missingValue;
                }

                finalIMA = i.De / i.Dr;
                finalAMA = i.Fr / i.Fe;
                finalEff = finalAMA / finalIMA;

                state.smResults = {
                    IMA: finalIMA, AMA: finalAMA, Eff: finalEff * 100,
                    solvedName: missingNameMap[missingVar],
                    solvedValue: missingValue,
                    solvedUnit: missingVar === 'Eff_perc' ? '%' : (missingVar.includes('F') ? '(N/lb)' : '(m/ft)'),
                };

            } catch (e) {
                state.smError = `Calculation Error: ${e.message}.`;
            }

            renderSimpleMachineView(false);
        };

        const calculateMachine = () => {
            // (Calculation logic remains the same)
            state.smResults = {}; state.smError = '';
            const config = MachineConfigs[state.activeSmTab];
            if (!config) { state.smError = 'Invalid machine selected.'; renderSimpleMachineView(false); return; }

            const prefix = config.prefix;
            const inputs = {
                Fe: parseFloat(state.smInputs[`Fe_${prefix}`]), Fr: parseFloat(state.smInputs[`Fr_${prefix}`]),
                Eff: parseFloat(state.smInputs[`Eff_${prefix}`]) / 100 
            };
            
            let IMA = null;
            let amaVarsCount = Object.values(inputs).filter(val => !isNaN(val)).length;
            let solvedName = null; let solvedValue = null; let finalAMA = null; let finalEff_perc = null; let solvedUnit = null;

            try {
                const imaInputs = {};
                let imaCount = 0;
                if (prefix === 'pul') {
                    imaInputs.Ima = parseFloat(state.smInputs.Ima_pul);
                    if (!isNaN(imaInputs.Ima)) imaCount++;
                } else if (prefix === 'scr') {
                    imaInputs.r = parseFloat(state.smInputs.r_scr);
                    imaInputs.p = parseFloat(state.smInputs.p_scr);
                    if (!isNaN(imaInputs.r)) imaCount++;
                    if (!isNaN(imaInputs.p)) imaCount++;
                } else {
                    imaInputs.De = parseFloat(state.smInputs[`De_${prefix}`]);
                    imaInputs.Dr = parseFloat(state.smInputs[`Dr_${prefix}`]);
                    if (!isNaN(imaInputs.De)) imaCount++;
                    if (!isNaN(imaInputs.Dr)) imaCount++;
                }

                const imaRequired = Object.keys(config.imaLabels).length;
                if (imaCount === imaRequired) {
                    IMA = config.formula(imaInputs);
                    if (IMA <= 0) throw new Error("IMA must be positive.");
                }
            } catch (e) {
                state.smError = `IMA Calculation Error: ${e.message}.`;
                renderSimpleMachineView(false); return;
            }

            const nameMap = { Fe: 'Effort Force ($F_e$)', Fr: 'Resistance Force ($F_r$)', Eff: 'Efficiency ($\eta$)' };
            
            try {
                if (IMA !== null) {
                    if (amaVarsCount === 3) {
                        finalAMA = inputs.Fr / inputs.Fe;
                        finalEff_perc = (finalAMA / IMA) * 100;
                        if (Math.abs(finalEff_perc - (inputs.Eff * 100)) > 1) {
                            state.smError = "Warning: Input values are inconsistent. Calculated $\\eta$ will be shown.";
                        } else {
                            finalEff_perc = inputs.Eff * 100;
                        }
                    } else if (amaVarsCount === 2) {
                        const missingKey = Object.keys(inputs).find(key => isNaN(inputs[key]));
                        
                        if (missingKey === 'Eff') {
                            finalAMA = inputs.Fr / inputs.Fe;
                            solvedValue = (finalAMA / IMA) * 100;
                            solvedName = nameMap.Eff;
                            finalEff_perc = solvedValue;
                            solvedUnit = '%';
                        } else if (missingKey === 'Fr') {
                            finalAMA = IMA * inputs.Eff;
                            solvedValue = finalAMA * inputs.Fe;
                            solvedName = nameMap.Fr;
                            finalEff_perc = inputs.Eff * 100;
                            solvedUnit = '(N/lb)';
                        } else if (missingKey === 'Fe') {
                            finalAMA = inputs.Fr / (IMA * inputs.Eff);
                            solvedValue = finalAMA * inputs.Fe;
                            solvedName = nameMap.Fe;
                            finalEff_perc = inputs.Eff * 100;
                            solvedUnit = '(N/lb)';
                        }
                    } else {
                        state.smError = 'IMA is calculated. Enter at least 2 of 3 AMA/Efficiency values.';
                        renderSimpleMachineView(false); return;
                    }
                } else {
                    if (inputs.Fr && inputs.Fe) {
                        finalAMA = inputs.Fr / inputs.Fe;
                        finalEff_perc = inputs.Eff ? inputs.Eff * 100 : null;
                        state.smError = 'IMA values are missing. Only AMA is calculated.';
                    } else {
                        state.smError = 'Enter all IMA values OR $F_e$ and $F_r$ to calculate AMA.';
                        renderSimpleMachineView(false); return;
                    }
                }
                
                state.smResults = {
                    IMA: IMA, AMA: finalAMA, Eff: finalEff_perc,
                    solvedName: solvedName, solvedValue: solvedValue, solvedUnit: solvedUnit,
                };

            } catch (e) {
                state.smError = `Calculation Error: ${e.message}.`;
            }

            renderSimpleMachineView(false);
        };

        const handleSmClear = (prefix) => {
            state.smResults = {}; state.smError = '';
            Object.keys(state.smInputs).forEach(key => {
                if (key.startsWith(prefix)) {
                    state.smInputs[key] = '';
                }
            });
            renderSimpleMachineView(false);
        };

        // --- Calculator Logic & Graphing ---
        
        const handleCalcClick = (buttonValue) => {
            state.calcError = '';
            if (buttonValue === 'clear') {
                state.calcInput = '';
                state.calcResult = '';
            } else if (buttonValue === 'del') {
                state.calcInput = state.calcInput.slice(0, -1);
            } else if (buttonValue === 'calculate') {
                try {
                    let expression = state.calcInput.replace(/ร/g, '*').replace(/รท/g, '/');
                    
                    const safeEval = createMathFunction(expression, state.angleMode);
                    let result = safeEval(0);

                    if (!isFinite(result)) {
                        state.calcResult = 'Error';
                        state.calcError = 'Result is undefined or too large.';
                    } else {
                        result = parseFloat(result.toFixed(state.precision));
                        state.calcResult = String(result);
                        state.calcInput = String(result);
                    }
                } catch (e) {
                    state.calcResult = 'Error';
                    state.calcError = 'Invalid expression or syntax error.';
                }
            } else {
                if (state.calcResult !== '' && state.calcInput === state.calcResult) {
                    state.calcResult = '';
                    state.calcInput = buttonValue;
                } else {
                    state.calcInput += buttonValue;
                }
            }
            renderCalculatorView(false);
        };

        const getCompiledFunction = (expression) => {
            if (!expression || expression.trim() === '') return null;
            try {
                const func = createMathFunction(expression, state.angleMode);
                func(0); 
                return func;
            } catch (e) {
                return null;
            }
        };

        /**
         * Draws the graph on the canvas and returns the error message (if any).
         */
        const drawGraph = () => {
            const canvas = document.getElementById('graphing-canvas');
            if (!canvas) return ''; // Cannot draw without canvas

            const ctx = canvas.getContext('2d');
            
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = 400; 

            const width = canvas.width;
            const height = canvas.height;
            ctx.clearRect(0, 0, width, height);

            const xMin = -10; const xMax = 10;
            const yMin = -10; const yMax = 10;
            const xScale = width / (xMax - xMin);
            const yScale = height / (yMax - yMin);
            const xOrigin = -xMin * xScale;
            const yOrigin = yMax * yScale;
            const canvasBg = state.theme === 'dark' ? '#1f2937' : '#f3f4f6';
            const gridColor = state.theme === 'dark' ? '#374151' : '#d1d5db';
            const labelColor = state.theme === 'dark' ? '#9ca3af' : '#6b7280';
            
            ctx.fillStyle = canvasBg;
            ctx.fillRect(0, 0, width, height);

            const toCanvas = (x, y) => ({
                px: x * xScale + xOrigin,
                py: -y * yScale + yOrigin,
            });

            // 1. Draw Grid and Axes
            ctx.strokeStyle = gridColor;
            ctx.lineWidth = 1;
            ctx.font = '10px Inter, sans-serif';
            ctx.fillStyle = labelColor;
            
            // Axes
            ctx.beginPath(); 
            ctx.moveTo(0, yOrigin); ctx.lineTo(width, yOrigin); ctx.stroke();
            ctx.moveTo(xOrigin, 0); ctx.lineTo(xOrigin, height); ctx.stroke();
            
            // Grid lines and labels
            for (let i = xMin; i <= xMax; i += 2) {
                const { px } = toCanvas(i, 0);
                if (i !== 0 && px > 0 && px < width) {
                    ctx.beginPath();
                    ctx.moveTo(px, yOrigin - 3); ctx.lineTo(px, yOrigin + 3); ctx.stroke();
                    ctx.fillText(i, px + 2, yOrigin + 15);
                }
            }
            for (let i = yMin; i <= yMax; i += 2) {
                const { py } = toCanvas(0, i);
                if (i !== 0 && py > 0 && py < height) {
                    ctx.beginPath();
                    ctx.moveTo(xOrigin - 3, py); ctx.lineTo(xOrigin + 3, py); ctx.stroke();
                    ctx.fillText(i, xOrigin + 10, py + 3);
                }
            }

            // 2. Draw the Function Curves
            let newError = '';
            
            state.functionInputs.forEach((funcObj, index) => {
                const compiledFunc = getCompiledFunction(funcObj.input);
                if (!compiledFunc) {
                    // Only store the first error detected
                    if (!newError) {
                        newError = `Error: Function ${index + 1} (${funcObj.input}) has invalid syntax.`;
                    }
                    return; 
                }

                ctx.strokeStyle = funcObj.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                let firstPoint = true;
                for (let px = 0; px <= width; px++) {
                    const x = (px - xOrigin) / xScale;
                    try {
                        const y = compiledFunc(x);
                        const { py } = toCanvas(x, y);

                        if (isFinite(y) && py >= -1000 && py <= height + 1000) {
                            if (firstPoint) {
                                ctx.moveTo(px, py);
                                firstPoint = false;
                            } else {
                                ctx.lineTo(px, py);
                            }
                        } else {
                            firstPoint = true;
                        }
                    } catch (error) {
                        firstPoint = true;
                    }
                }
                ctx.stroke();
            });

            return newError;
        };

        const addFunctionInput = () => {
            // Updated: Limit increased to 15
            if (state.functionInputs.length >= MAX_FUNCTIONS) {
                state.calcError = `Maximum of ${MAX_FUNCTIONS} functions allowed.`;
                renderCalculatorView(false);
                return;
            }
            const color = graphColors[state.functionInputs.length % graphColors.length];
            // Reverting: Adding a default function expression
            state.functionInputs.push({
                id: getNextFunctionId(),
                input: `sin(x) + ${state.functionInputs.length + 1}`,
                color: color
            });
            state.calcError = '';
            renderCalculatorView(false);
            setTimeout(drawGraph, 0); 
        };

        const removeFunctionInput = (id) => {
            if (state.functionInputs.length === 1) {
                state.calcError = 'You must have at least one function.';
                renderCalculatorView(false);
                return;
            }
            state.functionInputs = state.functionInputs.filter(f => f.id !== id);
            
            // Recalculate graph and check error state
            const originalError = state.calcError;
            const newError = drawGraph();
            state.calcError = newError;

            if (originalError !== newError) {
                renderCalculatorView(false);
            }
        };
        
        /**
         * Handles input change for graphing functions, updates state, redraws,
         * manages the error state, and restores focus. (FIXED)
         */
        const handleGraphFunctionInput = (e, id) => {
            const value = e.target.value;
            const activeElement = e.target;
            const inputId = id;
            const cursorStart = activeElement.selectionStart;
            const cursorEnd = activeElement.selectionEnd;

            // 1. Update the function input value in state
            const funcIndex = state.functionInputs.findIndex(f => f.id === id);
            if (funcIndex !== -1) {
                state.functionInputs[funcIndex].input = value;
            }
            
            // 2. Store current error state
            const originalError = state.calcError; 

            // 3. Draw the graph, which returns the calculated error message
            const newError = drawGraph(); 
            
            // 4. Update the global state error and check if the state changed
            const errorChanged = originalError !== newError;
            state.calcError = newError;

            // 5. Only re-render the surrounding view if the error state changed
            if (errorChanged) {
                renderCalculatorView(false);
            }

            // 6. Restore focus. Use a slight delay if a full re-render occurred.
            setTimeout(() => {
                const newActiveElement = document.querySelector(`[data-func-id="${inputId}"]`);
                if (newActiveElement) {
                    newActiveElement.focus();
                    newActiveElement.selectionStart = cursorStart;
                    newActiveElement.selectionEnd = cursorEnd;
                }
            }, errorChanged ? 50 : 0);
        };


        // --- Render Functions ---

        const renderHomeView = () => {
            const classes = getThemeClasses('card');
            
            document.getElementById('app-container').innerHTML = `
                <div class="p-4 sm:p-8 max-w-4xl mx-auto min-h-screen flex flex-col justify-center">
                    <h1 class="text-5xl font-extrabold text-indigo-400 mb-10 tracking-tight text-center">
                        engineering tools by Terminal_Dev
                    </h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- Simple Machine Tile -->
                        <button
                            data-view="simple-machine"
                            class="nav-button bg-indigo-600 p-6 rounded-3xl shadow-xl transition transform hover:scale-[1.02] hover:shadow-2xl
                                flex flex-col items-start text-left focus:outline-none focus:ring-4 focus:ring-indigo-500"
                        >
                            <div class="mb-4 p-3 rounded-xl bg-white/20">
                                <i data-lucide="scaling" class="w-8 h-8 text-white"></i>
                            </div>
                            <h2 class="text-xl font-semibold text-white mb-1">Simple Machine Analysis</h2>
                            <p class="text-sm text-white/80 leading-relaxed formula-text">Calculate IMA, AMA, and Efficiency ($\eta$) for six machine types.</p>
                        </button>

                        <!-- Calculator Tile -->
                        <button
                            data-view="calculator"
                            class="nav-button bg-blue-600 p-6 rounded-3xl shadow-xl transition transform hover:scale-[1.02] hover:shadow-2xl
                                flex flex-col items-start text-left focus:outline-none focus:ring-4 focus:ring-blue-500"
                        >
                            <div class="mb-4 p-3 rounded-xl bg-white/20">
                                <i data-lucide="calculator" class="w-8 h-8 text-white"></i>
                            </div>
                            <h2 class="text-xl font-semibold text-white mb-1">Scientific Calculator</h2>
                            <p class="text-sm text-white/80 leading-relaxed">Perform complex calculations and visualize functions f(x).</p>
                        </button>

                        <!-- Settings Tile -->
                        <button
                            data-view="settings"
                            class="nav-button bg-emerald-600 p-6 rounded-3xl shadow-xl transition transform hover:scale-[1.02] hover:shadow-2xl
                                flex flex-col items-start text-left focus:outline-none focus:ring-4 focus:ring-emerald-500"
                        >
                            <div class="mb-4 p-3 rounded-xl bg-white/20">
                                <i data-lucide="settings" class="w-8 h-8 text-white"></i>
                            </div>
                            <h2 class="text-xl font-semibold text-white mb-1">Settings</h2>
                            <p class="text-sm text-white/80 leading-relaxed">Adjust global precision, angle mode, and theme.</p>
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
            addNavListeners();
        };

        const renderGeneralSmContent = () => {
            const inputClass = getThemeClasses('input-field');
            const subtleText = getThemeClasses('subtle-text');
            const errorBox = getThemeClasses('error-box');

            const inputs = [
                { key: 'Fe_gen', label: 'Effort Force ($F_e$)', placeholder: 'e.g. 50', unit: 'Force (N/lb)' },
                { key: 'De_gen', label: 'Effort Distance ($D_e$)', placeholder: 'e.g. 5', unit: 'Distance (m/ft)' },
                { key: 'Fr_gen', label: 'Resistance Force ($F_r$)', placeholder: 'e.g. 400', unit: 'Force (N/lb)' },
                { key: 'Dr_gen', label: 'Resistance Distance ($D_r$)', placeholder: 'e.g. 1', unit: 'Distance (m/ft)' },
            ];

            return `
                <div>
                    <p class="text-sm ${subtleText} mb-4">
                        Enter <strong class="text-indigo-400">exactly four</strong> of the five variables ($F_e, D_e, F_r, D_r, \eta$) to solve for the missing one.
                    </p>
                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- General Input Fields -->
                        <div class="grid grid-cols-2 gap-6" id="sm-general-inputs">
                            ${inputs.map(input => `
                                <div class="input-group">
                                    <label class="block text-sm ${subtleText} formula-text">${input.label}</label>
                                    <input 
                                        type="text" 
                                        value="${state.smInputs[input.key] || ''}" 
                                        data-key="${input.key}"
                                        oninput="handleSmInputChange(event, '${input.key}')" 
                                        placeholder="${input.placeholder}" 
                                        class="input-field sm-input mt-1 w-full p-3 rounded-xl ${inputClass}" 
                                    />
                                    <p class="text-xs ${subtleText} mt-1">Unit: ${input.unit} (Enter numbers only)</p>
                                </div>
                            `).join('')}
                            <div class="input-group col-span-2">
                                <label class="block text-sm ${subtleText} formula-text">Efficiency ($\eta$)</label>
                                <input 
                                    type="text" 
                                    value="${state.smInputs.Eff_gen || ''}" 
                                    data-key="Eff_gen"
                                    oninput="handleSmInputChange(event, 'Eff_gen')" 
                                    placeholder="e.g. 67 (for 67%)" 
                                    class="input-field sm-input mt-1 w-full p-3 rounded-xl ${inputClass}" 
                                />
                                <p class="text-xs ${subtleText} mt-1">Unit: Percentage (0-100) (Enter numbers only)</p>
                            </div>
                        </div>
                        <!-- General Output Fields -->
                        <div class="space-y-4">
                            ${state.smResults.solvedName ? renderOutputCard('Missing Variable', state.smResults.solvedValue, state.smResults.solvedUnit, { border: 'border-yellow-500', bg: state.theme === 'dark' ? 'bg-yellow-900/40' : 'bg-yellow-100' }) : ''}
                            ${renderOutputCard('Ideal Mechanical Advantage (IMA)', state.smResults.IMA, '', { border: 'border-indigo-500', bg: state.theme === 'dark' ? 'bg-indigo-900/40' : 'bg-indigo-100' })}
                            ${renderOutputCard('Actual Mechanical Advantage (AMA)', state.smResults.AMA, '', { border: 'border-green-500', bg: state.theme === 'dark' ? 'bg-green-900/40' : 'bg-green-100' })}
                            ${renderOutputCard('Efficiency ($\eta$)', state.smResults.Eff, '%', { border: 'border-blue-500', bg: state.theme === 'dark' ? 'bg-blue-900/40' : 'bg-blue-100' })}
                        </div>
                    </div>
                    <div class="mt-8 flex space-x-4">
                        <button onclick="calculateGeneral()" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300 shadow-lg">
                            Calculate Results
                        </button>
                        <button onclick="handleSmClear('Fe_gen')" class="px-6 py-3 ${getThemeClasses('secondaryBg')} font-bold rounded-xl hover:bg-gray-500 transition duration-200 focus:outline-none focus:ring-4 focus:ring-gray-400 shadow-lg">
                            Clear
                        </button>
                    </div>
                </div>
            `;
        };

        const renderMachineSpecificContent = (config) => {
            const prefix = config.prefix;
            const tabKey = state.activeSmTab;
            const inputClass = getThemeClasses('input-field');
            const subtleText = getThemeClasses('subtle-text');
            const errorBox = getThemeClasses('error-box');

            const formulaDisplay = tabKey === 'lever' ? '<span class="formula-text">$IMA = L_e / L_r$</span>' 
                : tabKey === 'wheel-axle' ? '<span class="formula-text">$IMA = R_{wheel} / R_{axle}$</span>' 
                : tabKey === 'pulley' ? '<span class="formula-text">$IMA = N$ (Ropes)</span>'
                : tabKey === 'inclined-plane' ? '<span class="formula-text">$IMA = L / h$</span>'
                : tabKey === 'wedge' ? '<span class="formula-text">$IMA = L / t$</span>'
                : tabKey === 'screw' ? '<span class="formula-text">$IMA = 2\\pi r / p$</span>'
                : '';
            
            const inputsHtml = [];

            // IMA Inputs
            Object.keys(config.imaLabels).forEach(key => {
                const label = config.imaLabels[key];
                const inputKey = key === 'Ima' ? 'Ima_pul' : key === 'r' ? 'r_scr' : key === 'p' ? 'p_scr' : `${key}_${prefix}`;
                const colSpan = (prefix === 'pul') ? 'col-span-2' : '';
                
                inputsHtml.push(`
                    <div class="input-group ${colSpan}">
                        <label class="block text-sm ${subtleText} formula-text">${label}</label>
                        <input type="text" value="${state.smInputs[inputKey] || ''}" 
                            data-key="${inputKey}"
                            oninput="handleSmInputChange(event, '${inputKey}')" placeholder="e.g. ${key === 'Ima' ? '4' : '1'}" 
                            class="input-field sm-input mt-1 w-full p-3 rounded-xl ${inputClass}" />
                    </div>
                `);
            });

            // AMA/Efficiency Inputs (Standard)
            inputsHtml.push(`
                <div class="input-group">
                    <label class="block text-sm ${subtleText} formula-text">Effort Force ($F_e$)</label>
                    <input type="text" value="${state.smInputs[`Fe_${prefix}`] || ''}" 
                        data-key="Fe_${prefix}"
                        oninput="handleSmInputChange(event, 'Fe_${prefix}')" placeholder="e.g. 100" class="input-field sm-input mt-1 w-full p-3 rounded-xl ${inputClass}" />
                </div>
                <div class="input-group">
                    <label class="block text-sm ${subtleText} formula-text">Resistance Force ($F_r$)</label>
                    <input type="text" value="${state.smInputs[`Fr_${prefix}`] || ''}" 
                        data-key="Fr_${prefix}"
                        oninput="handleSmInputChange(event, 'Fr_${prefix}')" placeholder="e.g. 400" class="input-field sm-input mt-1 w-full p-3 rounded-xl ${inputClass}" />
                </div>
                <div class="input-group col-span-2">
                    <label class="block text-sm ${subtleText} formula-text">Efficiency ($\eta$)</label>
                    <input type="text" value="${state.smInputs[`Eff_${prefix}`] || ''}" 
                        data-key="Eff_${prefix}"
                        oninput="handleSmInputChange(event, 'Eff_${prefix}')" placeholder="e.g. 75 (for 75%)" class="input-field sm-input mt-1 w-full p-3 rounded-xl ${inputClass}" />
                    <p class="text-xs ${subtleText} mt-1">Unit: Percentage (0-100) (Enter numbers only)</p>
                </div>
            `);

            return `
                <div>
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">${tabLabels[tabKey]} Analysis (${formulaDisplay})</h3>
                    <p class="text-xs ${subtleText} mb-4">(Enter numbers only in the input fields.)</p>
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div class="grid grid-cols-2 gap-6">
                            ${inputsHtml.join('')}
                        </div>
                        <div class="space-y-4">
                            ${state.smResults.solvedName ? renderOutputCard('Solved Value', state.smResults.solvedValue, state.smResults.solvedUnit, { border: 'border-yellow-500', bg: state.theme === 'dark' ? 'bg-yellow-900/40' : 'bg-yellow-100' }) : ''}
                            ${renderOutputCard('Ideal Mechanical Advantage (IMA)', state.smResults.IMA, '', { border: 'border-indigo-500', bg: state.theme === 'dark' ? 'bg-indigo-900/40' : 'bg-indigo-100' })}
                            ${renderOutputCard('Actual Mechanical Advantage (AMA)', state.smResults.AMA, '', { border: 'border-green-500', bg: state.theme === 'dark' ? 'bg-green-900/40' : 'bg-green-100' })}
                            ${renderOutputCard('Efficiency ($\eta$)', state.smResults.Eff, '%', { border: 'border-blue-500', bg: state.theme === 'dark' ? 'bg-blue-900/40' : 'bg-blue-100' })}
                        </div>
                    </div>
                    <div class="mt-8 flex space-x-4">
                        <button onclick="calculateMachine()" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300 shadow-lg">
                            Calculate Machine Results
                        </button>
                        <button onclick="handleSmClear('${config.prefix}')" class="px-6 py-3 ${getThemeClasses('secondaryBg')} font-bold rounded-xl hover:bg-gray-500 transition duration-200 focus:outline-none focus:ring-4 focus:ring-gray-400 shadow-lg">
                            Clear
                        </button>
                    </div>
                </div>
            `;
        };

        const renderSimpleMachineView = (resetTab = true) => {
            if (resetTab) state.activeSmTab = 'general';
            const cardClass = getThemeClasses('card');
            const innerCardClass = getThemeClasses('inner-card');
            const subtleText = getThemeClasses('subtle-text');
            const errorBox = getThemeClasses('error-box');
            
            const tabsHtml = Object.keys(tabLabels).map(key => `
                <button
                    data-tab-key="${key}"
                    class="sm-tab p-3 rounded-t-lg font-semibold transition-all mr-2 whitespace-nowrap text-lg
                    ${state.activeSmTab === key ? getThemeClasses('tab-active') : getThemeClasses('tab-inactive')}
                    "
                >
                    ${tabLabels[key]}
                </button>
            `).join('');

            const contentHtml = state.activeSmTab === 'general' 
                ? renderGeneralSmContent()
                : renderMachineSpecificContent(MachineConfigs[state.activeSmTab]);

            document.getElementById('app-container').innerHTML = `
                <div class="p-4 sm:p-8 flex flex-col items-center min-h-screen">
                    <div class="w-full max-w-4xl flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-extrabold text-indigo-400 flex items-center">
                            <i data-lucide="hard-hat" class="w-7 h-7 mr-3 text-indigo-400"></i>
                            Machine Analysis Hub
                        </h1>
                        <button
                            data-view="home"
                            class="nav-button flex items-center text-sm font-medium ${subtleText} hover:text-white transition-colors ${getThemeClasses('inner-card')} p-3 rounded-xl shadow-md"
                        >
                            <i data-lucide="home" class="w-4 h-4 mr-1"></i>
                            Home
                        </button>
                    </div>

                    <div class="w-full max-w-4xl ${cardClass} p-6 rounded-3xl shadow-2xl">
                        
                        <!-- Tab Navigation -->
                        <div class="flex border-b ${state.theme === 'dark' ? 'border-gray-700' : 'border-gray-300'} mb-6 overflow-x-auto" id="sm-tabs">
                            ${tabsHtml}
                        </div>

                        <!-- Content -->
                        <div class="p-4 ${innerCardClass} rounded-xl">
                            <!-- Error Message Box -->
                            ${state.smError ? `<div class="${errorBox}" role="alert">${state.smError}</div>` : ''}
                            
                            ${contentHtml}
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            addNavListeners();
            addSmTabListeners();
        };

        const renderCalculatorView = (resetMode = true) => {
            if (resetMode) {
                state.calcMode = 'scientific';
                state.calcError = '';
            }

            const cardClass = getThemeClasses('card');
            const innerCardClass = getThemeClasses('inner-card');
            const inputClass = getThemeClasses('input-field');
            const subtleText = getThemeClasses('subtle-text');
            const errorBox = getThemeClasses('error-box');

            const scientificButtons = [
                { label: '(', value: '(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: ')', value: ')', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'sin', value: 'sin(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'cos', value: 'cos(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'tan', value: 'tan(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'log', value: 'log(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'exp', value: 'exp(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'sqrt', value: 'sqrt(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'x^y', value: '**', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'ฯ', value: 'Math.PI', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
            ];
            
            const mainButtons = [
                { label: 'C', value: 'clear', className: `col-span-2 ${getThemeClasses('calc-btn-clear')}` },
                { label: '<i data-lucide="redo-2" class="w-5 h-5"></i>', value: 'del', className: getThemeClasses('calc-btn-std') },
                { label: '<i data-lucide="divide" class="w-6 h-6"></i>', value: '/', className: getThemeClasses('calc-btn-accent') },
                { label: '7', value: '7', className: getThemeClasses('calc-btn-std') },
                { label: '8', value: '8', className: getThemeClasses('calc-btn-std') },
                { label: '9', value: '9', className: getThemeClasses('calc-btn-std') },
                { label: '<i data-lucide="x" class="w-6 h-6"></i>', value: '*', className: getThemeClasses('calc-btn-accent') },
                { label: '4', value: '4', className: getThemeClasses('calc-btn-std') },
                { label: '5', value: '5', className: getThemeClasses('calc-btn-std') },
                { label: '6', value: '6', className: getThemeClasses('calc-btn-std') },
                { label: '<i data-lucide="minus" class="w-6 h-6"></i>', value: '-', className: getThemeClasses('calc-btn-accent') },
                { label: '1', value: '1', className: getThemeClasses('calc-btn-std') },
                { label: '2', value: '2', className: getThemeClasses('calc-btn-std') },
                { label: '3', value: '3', className: getThemeClasses('calc-btn-std') },
                { label: '<i data-lucide="plus" class="w-6 h-6"></i>', value: '+', className: getThemeClasses('calc-btn-accent') },
                { label: '0', value: '0', className: `col-span-2 ${getThemeClasses('calc-btn-std')}` },
                { label: '.', value: '.', className: getThemeClasses('calc-btn-std') },
                { label: '<i data-lucide="equal" class="w-6 h-6"></i>', value: 'calculate', className: 'bg-green-600 hover:bg-green-700 text-white' },
            ];

            const scientificPad = `
                <div class="grid grid-cols-5 gap-3 mb-3">
                    ${scientificButtons.map((btn) => `
                        <button
                            data-value="${btn.value}"
                            onclick="handleCalcClick('${btn.value}')"
                            class="calc-button p-3 rounded-xl font-medium text-lg transition-all
                                shadow-md active:shadow-inner active:bg-indigo-600/30 ${btn.className}"
                        >
                            ${btn.label}
                        </button>
                    `).join('')}
                </div>

                <div class="grid grid-cols-4 gap-3">
                    ${mainButtons.map((btn) => `
                        <button
                            data-value="${btn.value}"
                            onclick="handleCalcClick('${btn.value}')"
                            class="calc-button p-4 rounded-xl font-bold text-2xl transition-all
                                shadow-md active:shadow-inner active:translate-y-0.5 ${btn.className}"
                        >
                            ${btn.label}
                        </button>
                    `).join('')}
                </div>
            `;

            const display = state.calcMode === 'scientific' ? `
                <div class="mb-6 ${getThemeClasses('inner-card')} p-4 rounded-2xl text-right overflow-hidden shadow-inner ${state.theme === 'dark' ? 'border-gray-700' : 'border-gray-200'}">
                    <p class="text-sm text-red-400 h-6 mb-1">${state.calcError}</p>
                    <div class="min-h-[2.5rem]">
                        <p class="${subtleText} text-lg break-all">${state.calcInput || '0'}</p>
                    </div>
                    <div class="min-h-[3rem]">
                        <p class="text-white text-5xl font-light break-all">${state.calcResult || ''}</p>
                    </div>
                </div>
                ${scientificPad}
            ` : `
                <div class="mb-6">
                    <!-- Graphing Syntax Guidance -->
                    <div class="p-3 mb-4 rounded-xl bg-blue-900/40 text-blue-300 text-sm">
                        <p class="font-semibold mb-1">Graphing Syntax:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>Use explicit equations (e.g., <code class="font-mono bg-black/30 p-0.5 rounded text-white">2*x + 1</code>). Do not use function names (e.g., "linear").</li>
                            <li>Use <code class="font-mono bg-black/30 p-0.5 rounded text-white">*</code> for multiplication (e.g., <code class="font-mono bg-black/30 p-0.5 rounded text-white">3*x</code>, not <code class="font-mono bg-black/30 p-0.5 rounded text-white">3x</code>).</li>
                            <li>Both <code class="font-mono bg-black/30 p-0.5 rounded text-white">^</code> and <code class="font-mono bg-black/30 p-0.5 rounded text-white">**</code> work for exponents (e.g., <code class="font-mono bg-black/30 p-0.5 rounded text-white">x^2</code>).</li>
                        </ul>
                    </div>

                    <div id="function-inputs" class="space-y-3 mb-4">
                        ${state.functionInputs.map(funcObj => `
                            <div class="flex items-center ${getThemeClasses('inner-card')} p-2 rounded-xl shadow-inner">
                                <span class="text-xl font-bold mr-2 w-8 text-center" style="color: ${funcObj.color};">
                                    f(x)
                                </span>
                                <input
                                    type="text"
                                    value="${funcObj.input}"
                                    data-func-id="${funcObj.id}"
                                    oninput="handleGraphFunctionInput(event, ${funcObj.id})"
                                    placeholder="e.g. 2*x + 1 or x^2 - 4"
                                    class="flex-grow bg-transparent focus:outline-none placeholder-gray-500 font-mono text-xl p-1"
                                />
                                <button 
                                    onclick="removeFunctionInput(${funcObj.id})"
                                    class="p-2 ml-2 text-red-400 hover:text-red-300 rounded-lg transition-colors"
                                    aria-label="Remove function"
                                    ${state.functionInputs.length === 1 ? 'disabled' : ''}
                                >
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>

                    <button
                        onclick="addFunctionInput()"
                        class="w-full py-2 mb-4 bg-indigo-600/20 text-indigo-400 rounded-xl font-semibold hover:bg-indigo-600/30 transition-colors flex items-center justify-center shadow-lg"
                    >
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add Function
                    </button>
                    
                    ${state.calcError && `<p class="text-sm text-red-400 mb-2 text-center">${state.calcError}</p>`}
                    <div class="border ${state.theme === 'dark' ? 'border-gray-700' : 'border-gray-300'} rounded-xl overflow-hidden shadow-lg">
                        <canvas id="graphing-canvas" class="w-full"></canvas>
                    </div>
                    <!-- Updated Limit Text -->
                    <p class="text-xs ${subtleText} mt-2 text-center">Default graphing range: X/Y from -10 to 10. Max ${MAX_FUNCTIONS} functions.</p>
                </div>
            `;

            document.getElementById('app-container').innerHTML = `
                <div class="p-4 sm:p-8 flex flex-col items-center min-h-screen">
                    <div class="w-full max-w-3xl flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-extrabold text-indigo-400 flex items-center">
                            <i data-lucide="calculator" class="w-7 h-7 mr-3 text-indigo-400"></i>
                            Calculator
                        </h1>
                        <button
                            data-view="home"
                            class="nav-button flex items-center text-sm font-medium ${subtleText} hover:text-white transition-colors ${getThemeClasses('inner-card')} p-3 rounded-xl shadow-md"
                        >
                            <i data-lucide="home" class="w-4 h-4 mr-1"></i>
                            Home
                        </button>
                    </div>

                    <div class="w-full max-w-3xl ${cardClass} p-6 rounded-3xl shadow-2xl">
                        <!-- Angle Mode Indicator -->
                        <p class="text-xs font-semibold text-center mb-4 p-1 rounded-full ${state.angleMode === 'degrees' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}">
                            Angle Mode: ${state.angleMode.toUpperCase()}
                        </p>

                        <!-- Mode Selector -->
                        <div class="flex justify-center mb-6 space-x-4">
                            <button
                                onclick="state.calcMode = 'scientific'; renderCalculatorView(false);"
                                class="
                                px-4 py-2 rounded-xl font-semibold transition-all flex items-center shadow-lg
                                ${state.calcMode === 'scientific' ? 'bg-indigo-600 text-white' : getThemeClasses('secondaryBg') + ' ' + subtleText + ' hover:bg-gray-600'}
                                "
                            >
                                <i data-lucide="calculator" class="w-5 h-5 mr-2"></i> Scientific
                            </button>
                            <button
                                onclick="state.calcMode = 'graphing'; renderCalculatorView(false);"
                                class="
                                px-4 py-2 rounded-xl font-semibold transition-all flex items-center shadow-lg
                                ${state.calcMode === 'graphing' ? 'bg-indigo-600 text-white' : getThemeClasses('secondaryBg') + ' ' + subtleText + ' hover:bg-gray-600'}
                                "
                            >
                                <i data-lucide="line-chart" class="w-5 h-5 mr-2"></i> Graphing
                            </button>
                        </div>
                        
                        ${display}
                    </div>
                </div>
            `;
            lucide.createIcons();
            addNavListeners();

            if (state.calcMode === 'graphing') {
                // Initial draw and error check
                const initialError = drawGraph();
                if (initialError !== state.calcError) {
                    state.calcError = initialError;
                    // Re-render only if the initial state had an error mismatch
                    setTimeout(() => renderCalculatorView(false), 0);
                }
                
                window.onresize = () => state.calcMode === 'graphing' && drawGraph();
            } else {
                window.onresize = null;
            }
        };

        const renderSettingsView = () => {
            const precisionOptions = [2, 4, 6, 8];
            const angleModeOptions = ['radians', 'degrees'];
            const cardClass = getThemeClasses('card');
            const innerCardClass = getThemeClasses('inner-card');
            const subtleText = getThemeClasses('subtle-text');

            const precisionButtons = precisionOptions.map(opt => `
                <button
                    onclick="state.precision = ${opt}; renderSettingsView();"
                    class="flex-1 p-4 rounded-xl font-bold transition-all shadow-md
                    ${state.precision === opt 
                        ? 'bg-indigo-600 text-white ring-2 ring-indigo-300' 
                        : getThemeClasses('secondaryBg') + ' ' + subtleText + ' hover:bg-gray-600'
                    }
                    "
                >
                    ${opt} Decimal Places
                    ${state.precision === opt ? '<i data-lucide="check" class="w-4 h-4 ml-2 inline-block"></i>' : ''}
                </button>
            `).join('');

            const angleModeButtons = angleModeOptions.map(mode => `
                <button
                    onclick="state.angleMode = '${mode}'; renderSettingsView();"
                    class="flex-1 p-4 rounded-xl font-bold capitalize transition-all shadow-md
                    ${state.angleMode === mode 
                        ? 'bg-indigo-600 text-white ring-2 ring-indigo-300' 
                        : getThemeClasses('secondaryBg') + ' ' + subtleText + ' hover:bg-gray-600'
                    }
                    "
                >
                    ${mode}
                    ${state.angleMode === mode ? '<i data-lucide="check" class="w-4 h-4 ml-2 inline-block"></i>' : ''}
                </button>
            `).join('');

            document.getElementById('app-container').innerHTML = `
                <div class="p-4 sm:p-8 flex flex-col items-center min-h-screen">
                    <div class="w-full max-w-4xl flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-extrabold text-emerald-400 flex items-center">
                            <i data-lucide="settings" class="w-7 h-7 mr-3 text-emerald-400"></i>
                            Application Settings
                        </h1>
                        <button
                            data-view="home"
                            class="nav-button flex items-center text-sm font-medium ${subtleText} hover:text-white transition-colors ${getThemeClasses('inner-card')} p-3 rounded-xl shadow-md"
                        >
                            <i data-lucide="home" class="w-4 h-4 mr-1"></i>
                            Home
                        </button>
                    </div>

                    <div class="w-full max-w-2xl ${cardClass} p-6 rounded-3xl shadow-2xl space-y-8">
                        
                        <!-- Theme Selector Setting (NEW) -->
                        <div>
                            <h2 class="text-xl font-bold text-indigo-600 mb-4 flex items-center">
                                <i data-lucide="sun-moon" class="w-5 h-5 mr-2"></i> Theme Selector
                            </h2>
                            <p class="text-sm ${subtleText} mb-4">
                                Switch between Dark Mode (easier on eyes) and Light Mode.
                            </p>
                            <div class="flex items-center justify-between space-x-4 p-4 ${getThemeClasses('inner-card')} rounded-xl">
                                <i data-lucide="sun" class="w-6 h-6 ${state.theme === 'light' ? 'text-yellow-500' : 'text-gray-500'}"></i>
                                
                                <!-- Toggle Switch -->
                                <label for="theme-toggle" class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="theme-toggle" class="sr-only peer" ${state.theme === 'dark' ? 'checked' : ''} onchange="toggleTheme()">
                                    <!-- Custom Toggle Style to handle both light/dark container backgrounds -->
                                    <div class="w-14 h-8 bg-gray-400 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-indigo-600"></div>
                                </label>
                                
                                <i data-lucide="moon" class="w-6 h-6 ${state.theme === 'dark' ? 'text-indigo-400' : 'text-gray-500'}"></i>
                            </div>
                        </div>

                        <!-- Calculation Precision Setting -->
                        <div>
                            <h2 class="text-xl font-bold text-indigo-600 mb-4 flex items-center">
                                <i data-lucide="chevron-right" class="w-5 h-5 mr-2"></i> Calculation Precision
                            </h2>
                            <p class="text-sm ${subtleText} mb-4">
                                Sets the number of decimal places for all displayed results.
                            </p>
                            <div class="flex space-x-4">
                                ${precisionButtons}
                            </div>
                        </div>

                        <!-- Angle Mode Setting -->
                        <div>
                            <h2 class="text-xl font-bold text-indigo-600 mb-4 flex items-center">
                                <i data-lucide="chevron-right" class="w-5 h-5 mr-2"></i> Angle Mode
                            </h2>
                            <p class="text-sm ${subtleText} mb-4">
                                Defines the unit used for trigonometric functions (sin, cos, tan).
                            </p>
                            <div class="flex space-x-4">
                                ${angleModeButtons}
                            </div>
                        </div>

                        <!-- Current Settings Summary -->
                        <div class="pt-4 border-t ${state.theme === 'dark' ? 'border-gray-700' : 'border-gray-300'}">
                            <h3 class="text-lg font-semibold ${subtleText}">Current Settings:</h3>
                            <p class="text-sm ${subtleText}">
                                Precision: <span class="font-mono">${state.precision}</span> | 
                                Angle Mode: <span class="font-mono capitalize">${state.angleMode}</span> |
                                Theme: <span class="font-mono capitalize">${state.theme}</span>
                            </p>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            addNavListeners();
        };

        const renderApp = () => {
            applyTheme(state.theme); // Apply body classes first
            window.onresize = null;

            switch (state.view) {
                case 'simple-machine':
                    renderSimpleMachineView(false); 
                    break;
                case 'calculator':
                    renderCalculatorView(false);
                    break;
                case 'settings':
                    renderSettingsView();
                    break;
                case 'home':
                default:
                    renderHomeView();
                    break;
            }
        };

        // --- Event Listener Management ---

        const addNavListeners = () => {
            document.querySelectorAll('.nav-button').forEach(button => {
                button.onclick = (e) => {
                    const newView = button.getAttribute('data-view');
                    if (newView) {
                        state.view = newView;
                        renderApp();
                    }
                };
            });
        };

        const addSmTabListeners = () => {
            document.querySelectorAll('.sm-tab').forEach(button => {
                button.onclick = (e) => {
                    const newTab = button.getAttribute('data-tab-key');
                    if (newTab) {
                        state.activeSmTab = newTab;
                        state.smResults = {}; 
                        state.smError = '';
                        renderSimpleMachineView(false); 
                    }
                };
            });
        };

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', renderApp);

    </script>
</body>
</html>
