<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>engineering tools by Terminal_Dev</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons for aesthetics -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Apply the Inter font globally */
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Style for LaTeX/formula display */
        .formula-text { 
            font-family: 'Times New Roman', serif; 
            font-style: italic; 
            font-weight: bold; 
        }
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #1f2937; }
        /* Canvas fix for responsiveness */
        #graphing-canvas { 
            width: 100%; 
            height: 400px; 
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <div id="app-container" class="min-h-screen">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <script>
        // --- Global State ---
        const state = {
            view: 'home', // 'home', 'calculator', 'simple-machine', 'settings'
            
            // Settings
            precision: 4, 
            angleMode: 'radians', // 'radians' or 'degrees'

            // Calculator State
            calcMode: 'scientific', // 'scientific' or 'graphing'
            calcInput: '',
            calcResult: '',
            calcError: '',
            functionInput: 'sin(x)',

            // Simple Machine State
            activeSmTab: 'general',
            smInputs: {
                // General
                Fe_gen: '', De_gen: '', Fr_gen: '', Dr_gen: '', Eff_gen: '',
                // Machine specific
                De_lev: '', Dr_lev: '', Fe_lev: '', Fr_lev: '', Eff_lev: '',
                De_wa: '', Dr_wa: '', Fe_wa: '', Fr_wa: '', Eff_wa: '',
                Ima_pul: '', Fe_pul: '', Fr_pul: '', Eff_pul: '',
                De_ip: '', Dr_ip: '', Fe_ip: '', Fr_ip: '', Eff_ip: '',
                De_wed: '', Dr_wed: '', Fe_wed: '', Fr_wed: '', Eff_wed: '',
                r_scr: '', p_scr: '', Fe_scr: '', Fr_scr: '', Eff_scr: '',
            },
            smResults: {},
            smError: '',
        };

        // --- Constants ---
        const MachineConfigs = {
            'lever': {
                prefix: 'lev', formula: (i) => i.De / i.Dr,
                imaLabels: { De: 'Effort Arm Length ($L_e$)', Dr: 'Resistance Arm Length ($L_r$)' },
            },
            'wheel-axle': {
                prefix: 'wa', formula: (i) => i.De / i.Dr,
                imaLabels: { De: 'Radius of Wheel ($R_{wheel}$)', Dr: 'Radius of Axle ($R_{axle}$)' },
            },
            'inclined-plane': {
                prefix: 'ip', formula: (i) => i.De / i.Dr,
                imaLabels: { De: 'Incline Length ($L$)', Dr: 'Vertical Height ($h$)' },
            },
            'wedge': {
                prefix: 'wed', formula: (i) => i.De / i.Dr,
                imaLabels: { De: 'Wedge Length ($L$)', Dr: 'Wedge Thickness ($t$)' },
            },
            'pulley': {
                prefix: 'pul', formula: (i) => i.Ima,
                imaLabels: { Ima: 'Number of Supporting Ropes ($N$)' },
            },
            'screw': {
                prefix: 'scr', formula: (i) => (2 * Math.PI * i.r) / i.p,
                imaLabels: { r: 'Effort Radius ($r$)', p: 'Pitch ($p$)' },
            }
        };

        const tabLabels = {
            'general': 'General Solver', 'lever': 'Lever', 'wheel-axle': 'Wheel & Axle', 
            'pulley': 'Pulley', 'inclined-plane': 'Inclined Plane', 'wedge': 'Wedge', 'screw': 'Screw',
        };

        const missingNameMap = { 
            Fe: 'Effort Force ($F_e$)', De: 'Effort Distance ($D_e$)', 
            Fr: 'Resistance Force ($F_r$)', Dr: 'Resistance Distance ($D_r$)', 
            Eff_perc: 'Efficiency ($\eta$)' 
        };
        
        // --- Utility Functions ---

        /**
         * Safely evaluates a math expression, handles angle conversion.
         */
        const createMathFunction = (expression, angleMode) => {
            let funcBody = expression.toLowerCase();
            
            // Replace common math functions/constants
            funcBody = funcBody.replace(/sin/g, 'Math.sin');
            funcBody = funcBody.replace(/cos/g, 'Math.cos');
            funcBody = funcBody.replace(/tan/g, 'Math.tan');
            funcBody = funcBody.replace(/log/g, 'Math.log');
            funcBody = funcBody.replace(/exp/g, 'Math.exp');
            funcBody = funcBody.replace(/sqrt/g, 'Math.sqrt');
            funcBody = funcBody.replace(/pi/g, 'Math.PI');
            funcBody = funcBody.replace(/e\b/g, 'Math.E');
            funcBody = funcBody.replace(/\^/g, '**');
            
            // Handle Degrees to Radians conversion for trig functions if angleMode is 'degrees'
            if (angleMode === 'degrees') {
                funcBody = funcBody.replace(/Math\.sin\(([^)]+)\)/g, 'Math.sin( (parseFloat($1) * Math.PI / 180) )');
                funcBody = funcBody.replace(/Math\.cos\(([^)]+)\)/g, 'Math.cos( (parseFloat($1) * Math.PI / 180) )');
                funcBody = funcBody.replace(/Math\.tan\(([^)]+)\)/g, 'Math.tan( (parseFloat($1) * Math.PI / 180) )');
            }

            try {
                // eslint-disable-next-line no-new-func
                return new Function('x', `
                    "use strict";
                    try {
                        const X = parseFloat(x);
                        return ${funcBody};
                    } catch (e) {
                        return NaN;
                    }
                `);
            } catch (e) {
                return () => { throw new Error("Invalid Function Syntax"); };
            }
        };

        /**
         * Formats a number to the specified decimal precision.
         */
        const formatNumber = (num, unit = '', precision) => {
            if (num === null || isNaN(num) || !isFinite(num)) return '--';
            return `${parseFloat(num).toFixed(precision)}${unit}`;
        };

        /**
         * Renders the output card HTML block.
         */
        const renderOutputCard = (title, value, unit, color) => {
            return `
                <div class="p-4 rounded-xl border-l-4 ${color.border} ${color.bg}">
                    <p class="text-sm font-medium text-gray-200">${title}:</p>
                    <p class="text-2xl font-extrabold text-white mt-1">
                        ${formatNumber(value, unit, state.precision)}
                    </p>
                </div>
            `;
        };
        
        // --- Simple Machine Logic ---

        /**
         * FIX: Handles input change, stores value, and restores focus after re-render.
         */
        const handleSmInputChange = (e, key) => {
            // 1. Store the new value
            state.smInputs[key] = e.target.value;
            state.smError = '';

            // 2. Capture focused element details before re-render
            const activeElement = e.target;
            const inputKey = activeElement.getAttribute('data-key');
            // Capture cursor position only if the input type supports it (i.e., type="text")
            const cursorStart = activeElement.selectionStart;
            const cursorEnd = activeElement.selectionEnd;

            // 3. Re-render the view (which causes focus loss)
            renderSimpleMachineView(false); 

            // 4. Restore focus and cursor position after re-render
            if (inputKey) {
                // Use a short timeout to wait for the DOM to update completely
                setTimeout(() => {
                    const newActiveElement = document.querySelector(`[data-key="${inputKey}"]`);
                    if (newActiveElement) {
                        newActiveElement.focus();
                        // This only works correctly for type="text", which we are now using.
                        newActiveElement.selectionStart = cursorStart;
                        newActiveElement.selectionEnd = cursorEnd;
                    }
                }, 0);
            }
        };

        const calculateGeneral = () => {
            state.smResults = {};
            state.smError = '';

            // Use parseFloat to convert text inputs to numbers
            const inputs = {
                Fe: parseFloat(state.smInputs.Fe_gen),
                De: parseFloat(state.smInputs.De_gen),
                Fr: parseFloat(state.smInputs.Fr_gen),
                Dr: parseFloat(state.smInputs.Dr_gen),
                Eff_perc: parseFloat(state.smInputs.Eff_gen)
            };
            
            const inputsRatio = {...inputs, Eff: inputs.Eff_perc / 100};

            const presentCount = Object.values(inputs).filter(val => !isNaN(val)).length;
            let missingVar = null;

            if (presentCount !== 4) {
                state.smError = `Please enter **exactly four** of the five values. You entered ${presentCount}.`;
                renderSimpleMachineView(false); // Fix: use false for re-render
                return;
            }

            for (const key in inputs) {
                if (isNaN(inputs[key])) {
                    missingVar = key;
                    break;
                }
            }
            
            const i = {...inputsRatio};
            delete i.Eff_perc;
            
            let missingValue = NaN;

            try {
                switch (missingVar) {
                    case 'Fe':
                        missingValue = (i.Fr * i.Dr) / (i.De * i.Eff); 
                        break;
                    case 'De':
                        missingValue = (i.Fr * i.Dr) / (i.Fe * i.Eff); 
                        break;
                    case 'Fr':
                        missingValue = (i.Fe * i.De * i.Eff) / i.Dr; 
                        break;
                    case 'Dr':
                        missingValue = (i.Fe * i.De * i.Eff) / i.Fr; 
                        break;
                    case 'Eff_perc':
                        const IMA_calc = i.De / i.Dr;
                        const AMA_calc = i.Fr / i.Fe;
                        missingValue = (AMA_calc / IMA_calc) * 100;
                        break;
                    default:
                        throw new Error("Missing variable not identified.");
                }

                if (!isFinite(missingValue) || missingValue < 0) {
                    state.smError = `Error: Result is non-finite or negative. Check for zero divisions or invalid inputs.`;
                    renderSimpleMachineView(false); // Fix: use false for re-render
                    return;
                }

                let finalIMA, finalAMA, finalEff;

                if (missingVar === 'Eff_perc') {
                    finalEff = missingValue / 100;
                } else {
                    i[missingVar] = missingValue;
                }

                // Recalculate IMA, AMA, and Eff with the complete set of inputs
                finalIMA = i.De / i.Dr;
                finalAMA = i.Fr / i.Fe;
                finalEff = finalAMA / finalIMA;

                state.smResults = {
                    IMA: finalIMA,
                    AMA: finalAMA,
                    Eff: finalEff * 100,
                    solvedName: missingNameMap[missingVar],
                    solvedValue: missingValue,
                    solvedUnit: missingVar === 'Eff_perc' ? '%' : (missingVar.includes('F') ? '(N/lb)' : '(m/ft)'),
                };

            } catch (e) {
                state.smError = `Calculation Error: ${e.message}.`;
            }

            renderSimpleMachineView(false); // Fix: use false for re-render
        };

        const calculateMachine = () => {
            state.smResults = {};
            state.smError = '';
            const config = MachineConfigs[state.activeSmTab];
            if (!config) {
                state.smError = 'Invalid machine selected.';
                renderSimpleMachineView(false); // Fix: use false for re-render
                return;
            }

            const prefix = config.prefix;
            // Use parseFloat to convert text inputs to numbers
            const inputs = {
                Fe: parseFloat(state.smInputs[`Fe_${prefix}`]),
                Fr: parseFloat(state.smInputs[`Fr_${prefix}`]),
                Eff: parseFloat(state.smInputs[`Eff_${prefix}`]) / 100 // Ratio
            };
            
            let IMA = null;
            let amaVarsCount = Object.values(inputs).filter(val => !isNaN(val)).length;
            let solvedName = null;
            let solvedValue = null;
            let finalAMA = null;
            let finalEff_perc = null;
            let solvedUnit = null;

            // 1. Calculate IMA
            try {
                const imaInputs = {};
                let imaCount = 0;
                if (prefix === 'pul') {
                    imaInputs.Ima = parseFloat(state.smInputs.Ima_pul);
                    if (!isNaN(imaInputs.Ima)) imaCount++;
                } else if (prefix === 'scr') {
                    imaInputs.r = parseFloat(state.smInputs.r_scr);
                    imaInputs.p = parseFloat(state.smInputs.p_scr);
                    if (!isNaN(imaInputs.r)) imaCount++;
                    if (!isNaN(imaInputs.p)) imaCount++;
                } else {
                    imaInputs.De = parseFloat(state.smInputs[`De_${prefix}`]);
                    imaInputs.Dr = parseFloat(state.smInputs[`Dr_${prefix}`]);
                    if (!isNaN(imaInputs.De)) imaCount++;
                    if (!isNaN(imaInputs.Dr)) imaCount++;
                }

                const imaRequired = Object.keys(config.imaLabels).length;
                if (imaCount === imaRequired) {
                    IMA = config.formula(imaInputs);
                    if (IMA <= 0) throw new Error("IMA must be positive.");
                }
            } catch (e) {
                state.smError = `IMA Calculation Error: ${e.message}.`;
                renderSimpleMachineView(false); // Fix: use false for re-render
                return;
            }

            const nameMap = { Fe: 'Effort Force ($F_e$)', Fr: 'Resistance Force ($F_r$)', Eff: 'Efficiency ($\eta$)' };
            
            // 2. Solve for AMA/Efficiency
            try {
                if (IMA !== null) {
                    if (amaVarsCount === 3) {
                        finalAMA = inputs.Fr / inputs.Fe;
                        finalEff_perc = (finalAMA / IMA) * 100;
                        if (Math.abs(finalEff_perc - (inputs.Eff * 100)) > 1) {
                            state.smError = "Warning: Input values are inconsistent. Calculated $\\eta$ will be shown.";
                        } else {
                            finalEff_perc = inputs.Eff * 100;
                        }
                    } else if (amaVarsCount === 2) {
                        const missingKey = Object.keys(inputs).find(key => isNaN(inputs[key]));
                        
                        if (missingKey === 'Eff') {
                            finalAMA = inputs.Fr / inputs.Fe;
                            solvedValue = (finalAMA / IMA) * 100;
                            solvedName = nameMap.Eff;
                            finalEff_perc = solvedValue;
                            solvedUnit = '%';
                        } else if (missingKey === 'Fr') {
                            finalAMA = IMA * inputs.Eff;
                            solvedValue = finalAMA * inputs.Fe;
                            solvedName = nameMap.Fr;
                            finalEff_perc = inputs.Eff * 100;
                            solvedUnit = '(N/lb)';
                        } else if (missingKey === 'Fe') {
                            finalAMA = inputs.Fr / (IMA * inputs.Eff);
                            solvedValue = finalAMA * inputs.Fe;
                            solvedName = nameMap.Fe;
                            finalEff_perc = inputs.Eff * 100;
                            solvedUnit = '(N/lb)';
                        }
                    } else {
                        state.smError = 'IMA is calculated. Enter at least 2 of 3 AMA/Efficiency values.';
                        renderSimpleMachineView(false); // Fix: use false for re-render
                        return;
                    }
                } else {
                    if (inputs.Fr && inputs.Fe) {
                        finalAMA = inputs.Fr / inputs.Fe;
                        finalEff_perc = inputs.Eff ? inputs.Eff * 100 : null;
                        state.smError = 'IMA values are missing. Only AMA is calculated.';
                    } else {
                        state.smError = 'Enter all IMA values OR $F_e$ and $F_r$ to calculate AMA.';
                        renderSimpleMachineView(false); // Fix: use false for re-render
                        return;
                    }
                }
                
                state.smResults = {
                    IMA: IMA,
                    AMA: finalAMA,
                    Eff: finalEff_perc,
                    solvedName: solvedName,
                    solvedValue: solvedValue,
                    solvedUnit: solvedUnit,
                };

            } catch (e) {
                state.smError = `Calculation Error: ${e.message}.`;
            }

            renderSimpleMachineView(false); // Fix: use false for re-render
        };

        const handleSmClear = (prefix) => {
            state.smResults = {};
            state.smError = '';
            
            Object.keys(state.smInputs).forEach(key => {
                if (key.startsWith(prefix)) {
                    state.smInputs[key] = '';
                }
            });
            renderSimpleMachineView(false); // Fix: use false for re-render
        };

        // --- Calculator Logic & Graphing ---
        
        const handleCalcClick = (buttonValue) => {
            state.calcError = '';
            if (buttonValue === 'clear') {
                state.calcInput = '';
                state.calcResult = '';
            } else if (buttonValue === 'del') {
                state.calcInput = state.calcInput.slice(0, -1);
            } else if (buttonValue === 'calculate') {
                try {
                    let expression = state.calcInput.replace(/×/g, '*').replace(/÷/g, '/');
                    
                    const safeEval = createMathFunction(expression, state.angleMode);
                    let result = safeEval(0); // Pass a dummy 'x' value

                    if (!isFinite(result)) {
                        state.calcResult = 'Error';
                        state.calcError = 'Result is undefined or too large.';
                    } else {
                        result = parseFloat(result.toFixed(state.precision));
                        state.calcResult = String(result);
                        state.calcInput = String(result);
                    }
                } catch (e) {
                    state.calcResult = 'Error';
                    state.calcError = 'Invalid expression or syntax error.';
                }
            } else {
                if (state.calcResult !== '' && state.calcInput === state.calcResult) {
                    state.calcResult = '';
                    state.calcInput = buttonValue;
                } else {
                    state.calcInput += buttonValue;
                }
            }
            renderCalculatorView(false); // Fix: use false for re-render
        };

        let f_x = null;
        let lastFunctionInput = '';
        let lastAngleMode = '';

        const getCompiledFunction = () => {
            if (state.functionInput === lastFunctionInput && state.angleMode === lastAngleMode && f_x) {
                return f_x;
            }

            lastFunctionInput = state.functionInput;
            lastAngleMode = state.angleMode;

            try {
                f_x = createMathFunction(state.functionInput, state.angleMode);
                f_x(0); // Test compilation
                state.calcError = '';
                return f_x;
            } catch (e) {
                state.calcError = 'Invalid Function Syntax';
                f_x = null;
                return null;
            }
        };

        const drawGraph = () => {
            const canvas = document.getElementById('graphing-canvas');
            const compiledFunc = getCompiledFunction();
            if (!canvas || !compiledFunc) return;

            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match container for responsiveness
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = 400; 

            const width = canvas.width;
            const height = canvas.height;
            ctx.clearRect(0, 0, width, height);

            const xMin = -10;
            const xMax = 10;
            const yMin = -10;
            const yMax = 10;
            const xScale = width / (xMax - xMin);
            const yScale = height / (yMax - yMin);
            const xOrigin = -xMin * xScale;
            const yOrigin = yMax * yScale;

            const toCanvas = (x, y) => ({
                px: x * xScale + xOrigin,
                py: -y * yScale + yOrigin,
            });

            // 1. Draw Grid and Axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.font = '10px Inter, sans-serif';
            ctx.fillStyle = '#999';
            
            // Axes
            ctx.beginPath(); 
            ctx.moveTo(0, yOrigin); ctx.lineTo(width, yOrigin); ctx.stroke();
            ctx.moveTo(xOrigin, 0); ctx.lineTo(xOrigin, height); ctx.stroke();
            
            // Grid lines and labels
            for (let i = xMin; i <= xMax; i += 2) {
                const { px } = toCanvas(i, 0);
                if (i !== 0 && px > 0 && px < width) {
                    ctx.beginPath();
                    ctx.moveTo(px, yOrigin - 3); ctx.lineTo(px, yOrigin + 3); ctx.stroke();
                    ctx.fillText(i, px + 2, yOrigin + 15);
                }
            }
            for (let i = yMin; i <= yMax; i += 2) {
                const { py } = toCanvas(0, i);
                if (i !== 0 && py > 0 && py < height) {
                    ctx.beginPath();
                    ctx.moveTo(xOrigin - 3, py); ctx.lineTo(xOrigin + 3, py); ctx.stroke();
                    ctx.fillText(i, xOrigin + 10, py + 3);
                }
            }

            // 2. Draw the Function Curve
            ctx.strokeStyle = '#3b82f6'; // Blue line
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            let firstPoint = true;
            for (let px = 0; px <= width; px++) {
                const x = (px - xOrigin) / xScale;
                try {
                    const y = compiledFunc(x);
                    const { py } = toCanvas(x, y);

                    // Basic bounds checking to prevent huge lines from tangent/asymptotes
                    if (isFinite(y) && py >= -1000 && py <= height + 1000) {
                        if (firstPoint) {
                            ctx.moveTo(px, py);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(px, py);
                        }
                    } else {
                        firstPoint = true;
                    }
                } catch (error) {
                    firstPoint = true;
                }
            }
            ctx.stroke();
            renderCalculatorView(false); // Update error display if needed
        };

        // --- Render Functions ---

        const renderHomeView = () => {
            document.getElementById('app-container').innerHTML = `
                <div class="p-4 sm:p-8 max-w-4xl mx-auto min-h-screen flex flex-col justify-center">
                    <h1 class="text-5xl font-extrabold text-white mb-10 tracking-tight text-center">
                        engineering tools by Terminal_Dev
                    </h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- Simple Machine Tile -->
                        <button
                            data-view="simple-machine"
                            class="nav-button bg-indigo-600 p-6 rounded-3xl shadow-xl transition transform hover:scale-[1.02] hover:shadow-2xl
                                flex flex-col items-start text-left focus:outline-none focus:ring-4 focus:ring-indigo-500"
                        >
                            <div class="mb-4 p-3 rounded-xl bg-white/20">
                                <i data-lucide="scaling" class="w-8 h-8 text-white"></i>
                            </div>
                            <h2 class="text-xl font-semibold text-white mb-1">Simple Machine Analysis</h2>
                            <p class="text-sm text-white/80 leading-relaxed formula-text">Calculate IMA, AMA, and Efficiency ($\eta$) for six machine types.</p>
                        </button>

                        <!-- Calculator Tile -->
                        <button
                            data-view="calculator"
                            class="nav-button bg-blue-600 p-6 rounded-3xl shadow-xl transition transform hover:scale-[1.02] hover:shadow-2xl
                                flex flex-col items-start text-left focus:outline-none focus:ring-4 focus:ring-blue-500"
                        >
                            <div class="mb-4 p-3 rounded-xl bg-white/20">
                                <i data-lucide="calculator" class="w-8 h-8 text-white"></i>
                            </div>
                            <h2 class="text-xl font-semibold text-white mb-1">Scientific Calculator</h2>
                            <p class="text-sm text-white/80 leading-relaxed">Perform complex calculations and visualize functions f(x).</p>
                        </button>

                        <!-- Settings Tile -->
                        <button
                            data-view="settings"
                            class="nav-button bg-emerald-600 p-6 rounded-3xl shadow-xl transition transform hover:scale-[1.02] hover:shadow-2xl
                                flex flex-col items-start text-left focus:outline-none focus:ring-4 focus:ring-emerald-500"
                        >
                            <div class="mb-4 p-3 rounded-xl bg-white/20">
                                <i data-lucide="settings" class="w-8 h-8 text-white"></i>
                            </div>
                            <h2 class="text-xl font-semibold text-white mb-1">Settings</h2>
                            <p class="text-sm text-white/80 leading-relaxed">Adjust global precision and calculation modes.</p>
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
            addNavListeners();
        };

        const renderGeneralSmContent = () => {
            const inputs = [
                { key: 'Fe_gen', label: 'Effort Force ($F_e$)', placeholder: 'e.g. 50', unit: 'Force (N/lb)' },
                { key: 'De_gen', label: 'Effort Distance ($D_e$)', placeholder: 'e.g. 5', unit: 'Distance (m/ft)' },
                { key: 'Fr_gen', label: 'Resistance Force ($F_r$)', placeholder: 'e.g. 400', unit: 'Force (N/lb)' },
                { key: 'Dr_gen', label: 'Resistance Distance ($D_r$)', placeholder: 'e.g. 1', unit: 'Distance (m/ft)' },
            ];

            return `
                <div>
                    <p class="text-sm text-gray-400 mb-4">
                        Enter <strong class="text-white">exactly four</strong> of the five variables ($F_e, D_e, F_r, D_r, \eta$) to solve for the missing one.
                    </p>
                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- General Input Fields -->
                        <div class="grid grid-cols-2 gap-6" id="sm-general-inputs">
                            ${inputs.map(input => `
                                <div class="input-group">
                                    <label class="block text-sm text-gray-300 formula-text">${input.label}</label>
                                    <input 
                                        type="text" 
                                        value="${state.smInputs[input.key] || ''}" 
                                        data-key="${input.key}"
                                        oninput="handleSmInputChange(event, '${input.key}')" 
                                        placeholder="${input.placeholder}" 
                                        class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" 
                                    />
                                    <p class="text-xs text-gray-500 mt-1">Unit: ${input.unit} (Enter numbers only)</p>
                                </div>
                            `).join('')}
                            <div class="input-group col-span-2">
                                <label class="block text-sm text-gray-300 formula-text">Efficiency ($\eta$)</label>
                                <input 
                                    type="text" 
                                    value="${state.smInputs.Eff_gen || ''}" 
                                    data-key="Eff_gen"
                                    oninput="handleSmInputChange(event, 'Eff_gen')" 
                                    placeholder="e.g. 67 (for 67%)" 
                                    class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" 
                                />
                                <p class="text-xs text-gray-500 mt-1">Unit: Percentage (0-100) (Enter numbers only)</p>
                            </div>
                        </div>
                        <!-- General Output Fields -->
                        <div class="space-y-4">
                            ${state.smResults.solvedName ? renderOutputCard('Missing Variable', state.smResults.solvedValue, state.smResults.solvedUnit, { border: 'border-yellow-500', bg: 'bg-yellow-900/40' }) : ''}
                            ${renderOutputCard('Ideal Mechanical Advantage (IMA)', state.smResults.IMA, '', { border: 'border-indigo-500', bg: 'bg-indigo-900/40' })}
                            ${renderOutputCard('Actual Mechanical Advantage (AMA)', state.smResults.AMA, '', { border: 'border-green-500', bg: 'bg-green-900/40' })}
                            ${renderOutputCard('Efficiency ($\eta$)', state.smResults.Eff, '%', { border: 'border-blue-500', bg: 'bg-blue-900/40' })}
                        </div>
                    </div>
                    <div class="mt-8 flex space-x-4">
                        <button onclick="calculateGeneral()" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300 shadow-lg">
                            Calculate Results
                        </button>
                        <button onclick="handleSmClear('Fe_gen')" class="px-6 py-3 bg-gray-600 text-white font-bold rounded-xl hover:bg-gray-500 transition duration-200 focus:outline-none focus:ring-4 focus:ring-gray-400 shadow-lg">
                            Clear
                        </button>
                    </div>
                </div>
            `;
        };

        const renderMachineSpecificContent = (config) => {
            const prefix = config.prefix;
            const tabKey = state.activeSmTab;

            const formulaDisplay = tabKey === 'lever' ? '<span class="formula-text">$IMA = L_e / L_r$</span>' 
                : tabKey === 'wheel-axle' ? '<span class="formula-text">$IMA = R_{wheel} / R_{axle}$</span>' 
                : tabKey === 'pulley' ? '<span class="formula-text">$IMA = N$ (Ropes)</span>'
                : tabKey === 'inclined-plane' ? '<span class="formula-text">$IMA = L / h$</span>'
                : tabKey === 'wedge' ? '<span class="formula-text">$IMA = L / t$</span>'
                : tabKey === 'screw' ? '<span class="formula-text">$IMA = 2\\pi r / p$</span>'
                : '';
            
            const inputsHtml = [];

            // IMA Inputs
            if (config.imaLabels.De) {
                inputsHtml.push(`
                    <div class="input-group">
                        <label class="block text-sm text-gray-300 formula-text">${config.imaLabels.De}</label>
                        <input type="text" value="${state.smInputs[`De_${prefix}`] || ''}" 
                            data-key="De_${prefix}"
                            oninput="handleSmInputChange(event, 'De_${prefix}')" placeholder="e.g. 5" class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" />
                    </div>
                    <div class="input-group">
                        <label class="block text-sm text-gray-300 formula-text">${config.imaLabels.Dr}</label>
                        <input type="text" value="${state.smInputs[`Dr_${prefix}`] || ''}" 
                            data-key="Dr_${prefix}"
                            oninput="handleSmInputChange(event, 'Dr_${prefix}')" placeholder="e.g. 1" class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" />
                    </div>
                `);
            } else if (config.imaLabels.Ima) {
                inputsHtml.push(`
                    <div class="input-group col-span-2">
                        <label class="block text-sm text-gray-300 formula-text">${config.imaLabels.Ima}</label>
                        <input type="text" value="${state.smInputs.Ima_pul || ''}" 
                            data-key="Ima_pul"
                            oninput="handleSmInputChange(event, 'Ima_pul')" placeholder="e.g. 4" class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" />
                    </div>
                `);
            } else if (config.imaLabels.r) {
                inputsHtml.push(`
                    <div class="input-group">
                        <label class="block text-sm text-gray-300 formula-text">${config.imaLabels.r}</label>
                        <input type="text" value="${state.smInputs.r_scr || ''}" 
                            data-key="r_scr"
                            oninput="handleSmInputChange(event, 'r_scr')" placeholder="e.g. 0.2" class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" />
                    </div>
                    <div class="input-group">
                        <label class="block text-sm text-gray-300 formula-text">${config.imaLabels.p}</label>
                        <input type="text" value="${state.smInputs.p_scr || ''}" 
                            data-key="p_scr"
                            oninput="handleSmInputChange(event, 'p_scr')" placeholder="e.g. 0.005" class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" />
                    </div>
                `);
            }

            // AMA/Efficiency Inputs (Standard)
            inputsHtml.push(`
                <div class="input-group">
                    <label class="block text-sm text-gray-300 formula-text">Effort Force ($F_e$)</label>
                    <input type="text" value="${state.smInputs[`Fe_${prefix}`] || ''}" 
                        data-key="Fe_${prefix}"
                        oninput="handleSmInputChange(event, 'Fe_${prefix}')" placeholder="e.g. 100" class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" />
                </div>
                <div class="input-group">
                    <label class="block text-sm text-gray-300 formula-text">Resistance Force ($F_r$)</label>
                    <input type="text" value="${state.smInputs[`Fr_${prefix}`] || ''}" 
                        data-key="Fr_${prefix}"
                        oninput="handleSmInputChange(event, 'Fr_${prefix}')" placeholder="e.g. 400" class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" />
                </div>
                <div class="input-group col-span-2">
                    <label class="block text-sm text-gray-300 formula-text">Efficiency ($\eta$)</label>
                    <input type="text" value="${state.smInputs[`Eff_${prefix}`] || ''}" 
                        data-key="Eff_${prefix}"
                        oninput="handleSmInputChange(event, 'Eff_${prefix}')" placeholder="e.g. 75 (for 75%)" class="input-field sm-input mt-1 w-full p-3 rounded-xl bg-gray-800 text-white border border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" />
                    <p class="text-xs text-gray-500 mt-1">Unit: Percentage (0-100) (Enter numbers only)</p>
                </div>
            `);

            return `
                <div>
                    <h3 class="text-xl font-bold text-indigo-400 mb-4">${tabLabels[tabKey]} Analysis (${formulaDisplay})</h3>
                    <p class="text-xs text-gray-500 mb-4">(Enter numbers only in the input fields.)</p>
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div class="grid grid-cols-2 gap-6">
                            ${inputsHtml.join('')}
                        </div>
                        <div class="space-y-4">
                            ${state.smResults.solvedName ? renderOutputCard('Solved Value', state.smResults.solvedValue, state.smResults.solvedUnit, { border: 'border-yellow-500', bg: 'bg-yellow-900/40' }) : ''}
                            ${renderOutputCard('Ideal Mechanical Advantage (IMA)', state.smResults.IMA, '', { border: 'border-indigo-500', bg: 'bg-indigo-900/40' })}
                            ${renderOutputCard('Actual Mechanical Advantage (AMA)', state.smResults.AMA, '', { border: 'border-green-500', bg: 'bg-green-900/40' })}
                            ${renderOutputCard('Efficiency ($\eta$)', state.smResults.Eff, '%', { border: 'border-blue-500', bg: 'bg-blue-900/40' })}
                        </div>
                    </div>
                    <div class="mt-8 flex space-x-4">
                        <button onclick="calculateMachine()" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-300 shadow-lg">
                            Calculate Machine Results
                        </button>
                        <button onclick="handleSmClear('${config.prefix}')" class="px-6 py-3 bg-gray-600 text-white font-bold rounded-xl hover:bg-gray-500 transition duration-200 focus:outline-none focus:ring-4 focus:ring-gray-400 shadow-lg">
                            Clear
                        </button>
                    </div>
                </div>
            `;
        };

        const renderSimpleMachineView = (resetTab = true) => {
            if (resetTab) state.activeSmTab = 'general';

            const tabsHtml = Object.keys(tabLabels).map(key => `
                <button
                    data-tab-key="${key}"
                    class="sm-tab p-3 rounded-t-lg font-semibold transition-all mr-2 whitespace-nowrap text-lg
                    ${state.activeSmTab === key ? 'bg-gray-700 text-indigo-400 border-b-2 border-indigo-400' : 'text-gray-400 hover:bg-gray-700'}
                    "
                >
                    ${tabLabels[key]}
                </button>
            `).join('');

            const contentHtml = state.activeSmTab === 'general' 
                ? renderGeneralSmContent()
                : renderMachineSpecificContent(MachineConfigs[state.activeSmTab]);

            document.getElementById('app-container').innerHTML = `
                <div class="p-4 sm:p-8 flex flex-col items-center min-h-screen">
                    <div class="w-full max-w-4xl flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-extrabold text-white flex items-center">
                            <i data-lucide="hard-hat" class="w-7 h-7 mr-3 text-indigo-400"></i>
                            Machine Analysis Hub
                        </h1>
                        <button
                            data-view="home"
                            class="nav-button flex items-center text-sm font-medium text-gray-300 hover:text-white transition-colors bg-gray-700/50 p-3 rounded-xl shadow-md"
                        >
                            <i data-lucide="home" class="w-4 h-4 mr-1"></i>
                            Home
                        </button>
                    </div>

                    <div class="w-full max-w-4xl bg-gray-800 p-6 rounded-3xl shadow-2xl">
                        
                        <!-- Tab Navigation -->
                        <div class="flex border-b border-gray-700 mb-6 overflow-x-auto" id="sm-tabs">
                            ${tabsHtml}
                        </div>

                        <!-- Content -->
                        <div class="p-4 bg-gray-700 rounded-xl">
                            <!-- Error Message Box -->
                            ${state.smError ? `
                                <div class="p-3 mb-4 rounded-xl text-sm text-red-300 bg-red-800/50 border border-red-700" role="alert">
                                    ${state.smError}
                                </div>
                            ` : ''}
                            
                            ${contentHtml}
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            addNavListeners();
            addSmTabListeners();
        };

        const renderCalculatorView = (resetMode = true) => {
            if (resetMode) {
                state.calcMode = 'scientific';
                state.calcError = '';
            }

            const scientificButtons = [
                { label: '(', value: '(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: ')', value: ')', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'sin', value: 'sin(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'cos', value: 'cos(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'tan', value: 'tan(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'log', value: 'log(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'exp', value: 'exp(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'sqrt', value: 'sqrt(', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'x^y', value: '**', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
                { label: 'π', value: 'Math.PI', className: 'bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400' },
            ];
            
            const mainButtons = [
                { label: 'C', value: 'clear', className: 'col-span-2 bg-red-600/20 hover:bg-red-600/30 text-red-300' },
                { label: '<i data-lucide="redo-2" class="w-5 h-5"></i>', value: 'del', className: 'bg-gray-700 hover:bg-gray-600 text-gray-300' },
                { label: '<i data-lucide="divide" class="w-6 h-6"></i>', value: '/', className: 'bg-indigo-600 hover:bg-indigo-700/80 text-white' },
                { label: '7', value: '7', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '8', value: '8', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '9', value: '9', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '<i data-lucide="x" class="w-6 h-6"></i>', value: '*', className: 'bg-indigo-600 hover:bg-indigo-700/80 text-white' },
                { label: '4', value: '4', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '5', value: '5', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '6', value: '6', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '<i data-lucide="minus" class="w-6 h-6"></i>', value: '-', className: 'bg-indigo-600 hover:bg-indigo-700/80 text-white' },
                { label: '1', value: '1', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '2', value: '2', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '3', value: '3', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '<i data-lucide="plus" class="w-6 h-6"></i>', value: '+', className: 'bg-indigo-600 hover:bg-indigo-700/80 text-white' },
                { label: '0', value: '0', className: 'col-span-2 bg-gray-800 hover:bg-gray-700' },
                { label: '.', value: '.', className: 'bg-gray-800 hover:bg-gray-700' },
                { label: '<i data-lucide="equal" class="w-6 h-6"></i>', value: 'calculate', className: 'bg-green-600 hover:bg-green-700 text-white' },
            ];

            const scientificPad = `
                <div class="grid grid-cols-5 gap-3 mb-3">
                    ${scientificButtons.map((btn) => `
                        <button
                            data-value="${btn.value}"
                            onclick="handleCalcClick('${btn.value}')"
                            class="calc-button p-3 rounded-xl text-white font-medium text-lg transition-all
                                shadow-md active:shadow-inner active:bg-indigo-600/30 ${btn.className}"
                        >
                            ${btn.label}
                        </button>
                    `).join('')}
                </div>

                <div class="grid grid-cols-4 gap-3">
                    ${mainButtons.map((btn) => `
                        <button
                            data-value="${btn.value}"
                            onclick="handleCalcClick('${btn.value}')"
                            class="calc-button p-4 rounded-xl text-white font-bold text-2xl transition-all
                                shadow-md active:shadow-inner active:translate-y-0.5 ${btn.className}"
                        >
                            ${btn.label}
                        </button>
                    `).join('')}
                </div>
            `;

            const display = state.calcMode === 'scientific' ? `
                <div class="mb-6 bg-gray-900 p-4 rounded-2xl text-right overflow-hidden shadow-inner border border-gray-700">
                    <p class="text-sm text-red-400 h-6 mb-1">${state.calcError}</p>
                    <div class="min-h-[2.5rem]">
                        <p class="text-gray-400 text-lg break-all">${state.calcInput || '0'}</p>
                    </div>
                    <div class="min-h-[3rem]">
                        <p class="text-white text-5xl font-light break-all">${state.calcResult || ''}</p>
                    </div>
                </div>
                ${scientificPad}
            ` : `
                <div class="mb-6">
                    <div class="flex mb-4 items-center bg-gray-900 p-3 rounded-xl shadow-inner border border-gray-700">
                        <span class="text-xl text-white font-mono mr-2">f(x) =</span>
                        <input
                            type="text"
                            value="${state.functionInput}"
                            oninput="state.functionInput = this.value; drawGraph();"
                            placeholder="e.g. sin(x) + x/2"
                            class="flex-grow bg-transparent text-white focus:outline-none placeholder-gray-500 font-mono text-xl"
                        />
                    </div>
                    ${state.calcError && `<p class="text-sm text-red-400 mb-2 text-center">${state.calcError}</p>`}
                    <div class="border border-gray-700 rounded-xl overflow-hidden shadow-lg">
                        <canvas id="graphing-canvas" class="w-full bg-gray-900"></canvas>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Default graphing range: X/Y from -10 to 10.</p>
                </div>
            `;

            document.getElementById('app-container').innerHTML = `
                <div class="p-4 sm:p-8 flex flex-col items-center min-h-screen bg-gray-900">
                    <div class="w-full max-w-4xl flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-extrabold text-white flex items-center">
                            <i data-lucide="calculator" class="w-7 h-7 mr-3 text-indigo-400"></i>
                            Calculator
                        </h1>
                        <button
                            data-view="home"
                            class="nav-button flex items-center text-sm font-medium text-gray-300 hover:text-white transition-colors bg-gray-700/50 p-3 rounded-xl shadow-md"
                        >
                            <i data-lucide="home" class="w-4 h-4 mr-1"></i>
                            Home
                        </button>
                    </div>

                    <div class="w-full max-w-3xl bg-gray-800 p-6 rounded-3xl shadow-2xl">
                        <!-- Angle Mode Indicator -->
                        <p class="text-xs font-semibold text-center mb-4 p-1 rounded-full ${state.angleMode === 'degrees' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}">
                            Angle Mode: ${state.angleMode.toUpperCase()}
                        </p>

                        <!-- Mode Selector -->
                        <div class="flex justify-center mb-6 space-x-4">
                            <button
                                onclick="state.calcMode = 'scientific'; renderCalculatorView(false);"
                                class="
                                px-4 py-2 rounded-xl font-semibold transition-all flex items-center shadow-lg
                                ${state.calcMode === 'scientific' ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}
                                "
                            >
                                <i data-lucide="calculator" class="w-5 h-5 mr-2"></i> Scientific
                            </button>
                            <button
                                onclick="state.calcMode = 'graphing'; renderCalculatorView(false);"
                                class="
                                px-4 py-2 rounded-xl font-semibold transition-all flex items-center shadow-lg
                                ${state.calcMode === 'graphing' ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}
                                "
                            >
                                <i data-lucide="line-chart" class="w-5 h-5 mr-2"></i> Graphing
                            </button>
                        </div>
                        
                        ${display}
                    </div>
                </div>
            `;
            lucide.createIcons();
            addNavListeners();

            if (state.calcMode === 'graphing') {
                // Wait for the canvas to be in the DOM, then draw
                setTimeout(drawGraph, 0); 
                window.onresize = () => state.calcMode === 'graphing' && drawGraph();
            } else {
                window.onresize = null;
            }
        };

        const renderSettingsView = () => {
            const precisionOptions = [2, 4, 6, 8];
            const angleModeOptions = ['radians', 'degrees'];

            const precisionButtons = precisionOptions.map(opt => `
                <button
                    onclick="state.precision = ${opt}; renderSettingsView();"
                    class="flex-1 p-4 rounded-xl font-bold transition-all shadow-md
                    ${state.precision === opt 
                        ? 'bg-indigo-600 text-white ring-2 ring-indigo-300' 
                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    }
                    "
                >
                    ${opt} Decimal Places
                    ${state.precision === opt ? '<i data-lucide="check" class="w-4 h-4 ml-2 inline-block"></i>' : ''}
                </button>
            `).join('');

            const angleModeButtons = angleModeOptions.map(mode => `
                <button
                    onclick="state.angleMode = '${mode}'; renderSettingsView();"
                    class="flex-1 p-4 rounded-xl font-bold capitalize transition-all shadow-md
                    ${state.angleMode === mode 
                        ? 'bg-indigo-600 text-white ring-2 ring-indigo-300' 
                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    }
                    "
                >
                    ${mode}
                    ${state.angleMode === mode ? '<i data-lucide="check" class="w-4 h-4 ml-2 inline-block"></i>' : ''}
                </button>
            `).join('');

            document.getElementById('app-container').innerHTML = `
                <div class="p-4 sm:p-8 flex flex-col items-center min-h-screen">
                    <div class="w-full max-w-4xl flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-extrabold text-white flex items-center">
                            <i data-lucide="settings" class="w-7 h-7 mr-3 text-emerald-400"></i>
                            Application Settings
                        </h1>
                        <button
                            data-view="home"
                            class="nav-button flex items-center text-sm font-medium text-gray-300 hover:text-white transition-colors bg-gray-700/50 p-3 rounded-xl shadow-md"
                        >
                            <i data-lucide="home" class="w-4 h-4 mr-1"></i>
                            Home
                        </button>
                    </div>

                    <div class="w-full max-w-2xl bg-gray-800 p-6 rounded-3xl shadow-2xl space-y-8">
                        
                        <!-- Calculation Precision Setting -->
                        <div>
                            <h2 class="text-xl font-bold text-indigo-400 mb-4 flex items-center">
                                <i data-lucide="chevron-right" class="w-5 h-5 mr-2"></i> Calculation Precision
                            </h2>
                            <p class="text-sm text-gray-400 mb-4">
                                Sets the number of decimal places for all displayed results in the Calculator and Machine Hub.
                            </p>
                            <div class="flex space-x-4">
                                ${precisionButtons}
                            </div>
                        </div>

                        <!-- Angle Mode Setting -->
                        <div>
                            <h2 class="text-xl font-bold text-indigo-400 mb-4 flex items-center">
                                <i data-lucide="chevron-right" class="w-5 h-5 mr-2"></i> Angle Mode
                            </h2>
                            <p class="text-sm text-gray-400 mb-4">
                                Defines the unit used for trigonometric functions (sin, cos, tan) in the Calculator.
                            </p>
                            <div class="flex space-x-4">
                                ${angleModeButtons}
                            </div>
                        </div>

                        <!-- Current Settings Summary -->
                        <div class="pt-4 border-t border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-300 mb-2">Current Settings:</h3>
                            <p class="text-sm text-gray-400">
                                Precision: <span class="text-white font-mono">${state.precision}</span> | 
                                Angle Mode: <span class="text-white font-mono capitalize">${state.angleMode}</span>
                            </p>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            addNavListeners();
        };

        const renderApp = () => {
            // Remove previous event listeners
            window.onresize = null;

            switch (state.view) {
                case 'simple-machine':
                    renderSimpleMachineView(false); // don't reset tab on re-render
                    break;
                case 'calculator':
                    renderCalculatorView(false);
                    break;
                case 'settings':
                    renderSettingsView();
                    break;
                case 'home':
                default:
                    renderHomeView();
                    break;
            }
        };

        // --- Event Listener Management ---

        const addNavListeners = () => {
            document.querySelectorAll('.nav-button').forEach(button => {
                button.onclick = (e) => {
                    const newView = button.getAttribute('data-view');
                    if (newView) {
                        state.view = newView;
                        renderApp();
                    }
                };
            });
        };

        const addSmTabListeners = () => {
            document.querySelectorAll('.sm-tab').forEach(button => {
                button.onclick = (e) => {
                    const newTab = button.getAttribute('data-tab-key');
                    if (newTab) {
                        state.activeSmTab = newTab;
                        state.smResults = {}; // Clear results on tab switch
                        state.smError = '';
                        // Re-render the current view to show new tab content
                        renderSimpleMachineView(false); 
                    }
                };
            });
        };

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', renderApp);

    </script>
</body>
</html>
